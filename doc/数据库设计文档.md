# 健康守护小程序 - 数据库设计文档

## 文档说明

本文档详细描述了健康守护微信小程序的数据库设计，包括表结构、字段说明、索引设计和关系图。

## 数据库基本信息

- **数据库名称**: health_guard_db
- **数据库版本**: MySQL 8.0
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **时区**: Asia/Shanghai

## 数据表设计

### 1. 用户相关表

#### 1.1 用户基础信息表 (users)

```sql
CREATE TABLE `users` (
  `id` varchar(50) NOT NULL COMMENT '用户ID',
  `open_id` varchar(100) NOT NULL COMMENT '微信OpenID',
  `union_id` varchar(100) DEFAULT NULL COMMENT '微信UnionID',
  `nickname` varchar(100) NOT NULL COMMENT '昵称',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `id_card` varchar(20) DEFAULT NULL COMMENT '身份证号',
  `age` int DEFAULT NULL COMMENT '年龄',
  `gender` enum('男','女','未知') DEFAULT '未知' COMMENT '性别',
  `birthday` date DEFAULT NULL COMMENT '生日',
  `member_level` enum('regular','vip') DEFAULT 'regular' COMMENT '会员等级',
  `status` enum('active','inactive','frozen') DEFAULT 'active' COMMENT '用户状态',
  `service_count` int DEFAULT 0 COMMENT '服务次数',
  `total_spent` decimal(10,2) DEFAULT 0.00 COMMENT '总消费金额',
  `emergency_contact` varchar(100) DEFAULT NULL COMMENT '紧急联系人',
  `emergency_relation` varchar(20) DEFAULT NULL COMMENT '紧急联系人关系',
  `health_condition` varchar(200) DEFAULT NULL COMMENT '健康状况',
  `allergies` text DEFAULT NULL COMMENT '过敏史',
  `medical_history` text DEFAULT NULL COMMENT '病史',
  `preferred_services` json DEFAULT NULL COMMENT '偏好服务',
  `device_info` json DEFAULT NULL COMMENT '设备信息',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `last_login_time` timestamp NULL DEFAULT NULL COMMENT '最后登录时间',
  `register_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_open_id` (`open_id`),
  KEY `idx_phone` (`phone`),
  KEY `idx_status` (`status`),
  KEY `idx_member_level` (`member_level`),
  KEY `idx_register_time` (`register_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户基础信息表';
```

#### 1.2 用户地址表 (user_addresses)

```sql
CREATE TABLE `user_addresses` (
  `id` varchar(50) NOT NULL COMMENT '地址ID',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `contact_name` varchar(50) NOT NULL COMMENT '联系人姓名',
  `contact_phone` varchar(20) NOT NULL COMMENT '联系人电话',
  `address` varchar(500) NOT NULL COMMENT '详细地址',
  `latitude` decimal(10,6) DEFAULT NULL COMMENT '纬度',
  `longitude` decimal(10,6) DEFAULT NULL COMMENT '经度',
  `is_default` tinyint(1) DEFAULT 0 COMMENT '是否默认地址',
  `visit_count` int DEFAULT 0 COMMENT '服务次数',
  `last_visit` timestamp NULL DEFAULT NULL COMMENT '最后服务时间',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_default` (`is_default`),
  CONSTRAINT `fk_address_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

### 2. 服务相关表

#### 2.1 服务类型表 (service_types)

```sql
CREATE TABLE `service_types` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '服务类型ID',
  `name` varchar(100) NOT NULL COMMENT '服务名称',
  `description` text COMMENT '服务描述',
  `price` decimal(10,2) NOT NULL COMMENT '服务价格',
  `duration` int DEFAULT 60 COMMENT '服务时长(分钟)',
  `category` varchar(50) DEFAULT NULL COMMENT '服务分类',
  `icon` varchar(10) DEFAULT NULL COMMENT '图标',
  `is_active` tinyint(1) DEFAULT 1 COMMENT '是否启用',
  `sort_order` int DEFAULT 0 COMMENT '排序',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_category` (`category`),
  KEY `idx_is_active` (`is_active`),
  KEY `idx_sort_order` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务类型表';
```

#### 2.2 预约订单表 (bookings)

```sql
CREATE TABLE `bookings` (
  `id` varchar(50) NOT NULL COMMENT '预约ID',
  `order_no` varchar(50) NOT NULL COMMENT '订单号',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `service_id` int NOT NULL COMMENT '服务类型ID',
  `nurse_id` varchar(50) DEFAULT NULL COMMENT '护士ID',
  `appointment_time` timestamp NOT NULL COMMENT '预约时间',
  `duration` int DEFAULT 60 COMMENT '预计时长(分钟)',
  `status` enum('pending','confirmed','in_progress','completed','cancelled') DEFAULT 'pending' COMMENT '预约状态',
  `urgency` enum('normal','urgent','emergency') DEFAULT 'normal' COMMENT '紧急程度',
  `price` decimal(10,2) NOT NULL COMMENT '服务价格',
  `address_id` varchar(50) NOT NULL COMMENT '服务地址ID',
  `notes` text DEFAULT NULL COMMENT '备注信息',
  `cancel_reason` varchar(200) DEFAULT NULL COMMENT '取消原因',
  `confirm_time` timestamp NULL DEFAULT NULL COMMENT '确认时间',
  `start_time` timestamp NULL DEFAULT NULL COMMENT '开始时间',
  `end_time` timestamp NULL DEFAULT NULL COMMENT '结束时间',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_nurse_id` (`nurse_id`),
  KEY `idx_status` (`status`),
  KEY `idx_appointment_time` (`appointment_time`),
  CONSTRAINT `fk_booking_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_booking_service` FOREIGN KEY (`service_id`) REFERENCES `service_types` (`id`),
  CONSTRAINT `fk_booking_address` FOREIGN KEY (`address_id`) REFERENCES `user_addresses` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预约订单表';
```

#### 2.3 服务记录表 (service_records)

```sql
CREATE TABLE `service_records` (
  `id` varchar(50) NOT NULL COMMENT '服务记录ID',
  `booking_id` varchar(50) NOT NULL COMMENT '预约ID',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `nurse_id` varchar(50) NOT NULL COMMENT '护士ID',
  `service_id` int NOT NULL COMMENT '服务类型ID',
  `service_time` timestamp NOT NULL COMMENT '服务时间',
  `duration` int NOT NULL COMMENT '实际时长(分钟)',
  `status` enum('completed','cancelled') DEFAULT 'completed' COMMENT '服务状态',
  `cost` decimal(10,2) NOT NULL COMMENT '服务费用',
  `address_id` varchar(50) NOT NULL COMMENT '服务地址ID',
  `service_report` json DEFAULT NULL COMMENT '服务报告',
  `rating` int DEFAULT NULL COMMENT '用户评分(1-5)',
  `feedback` text DEFAULT NULL COMMENT '用户反馈',
  `tags` json DEFAULT NULL COMMENT '评价标签',
  `images` json DEFAULT NULL COMMENT '服务图片',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_booking_id` (`booking_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_nurse_id` (`nurse_id`),
  KEY `idx_service_time` (`service_time`),
  KEY `idx_rating` (`rating`),
  CONSTRAINT `fk_record_booking` FOREIGN KEY (`booking_id`) REFERENCES `bookings` (`id`),
  CONSTRAINT `fk_record_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务记录表';
```

### 3. 健康相关表

#### 3.1 健康记录表 (health_records)

```sql
CREATE TABLE `health_records` (
  `id` varchar(50) NOT NULL COMMENT '记录ID',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `type` varchar(50) NOT NULL COMMENT '记录类型',
  `value` json NOT NULL COMMENT '记录值',
  `unit` varchar(20) DEFAULT NULL COMMENT '单位',
  `record_time` timestamp NOT NULL COMMENT '记录时间',
  `source` enum('self','nurse','device','doctor') DEFAULT 'self' COMMENT '数据来源',
  `notes` text DEFAULT NULL COMMENT '备注',
  `images` json DEFAULT NULL COMMENT '相关图片',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_record_time` (`record_time`),
  KEY `idx_source` (`source`),
  CONSTRAINT `fk_health_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='健康记录表';
```

#### 3.2 健康报告表 (health_reports)

```sql
CREATE TABLE `health_reports` (
  `id` varchar(50) NOT NULL COMMENT '报告ID',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `report_type` enum('weekly','monthly','quarterly','yearly') DEFAULT 'monthly' COMMENT '报告类型',
  `period_start` date NOT NULL COMMENT '报告周期开始',
  `period_end` date NOT NULL COMMENT '报告周期结束',
  `overall_score` int DEFAULT NULL COMMENT '综合评分',
  `risk_level` enum('low','medium','high') DEFAULT 'low' COMMENT '风险等级',
  `summary` json DEFAULT NULL COMMENT '总结信息',
  `details` json DEFAULT NULL COMMENT '详细数据',
  `suggestions` json DEFAULT NULL COMMENT '建议',
  `generate_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '生成时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_period` (`period_start`, `period_end`),
  CONSTRAINT `fk_report_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='健康报告表';
```

### 4. 社区相关表

#### 4.1 社区动态表 (community_posts)

```sql
CREATE TABLE `community_posts` (
  `id` varchar(50) NOT NULL COMMENT '动态ID',
  `user_id` varchar(50) NOT NULL COMMENT '用户ID',
  `type` enum('health','experience','question','sharing') DEFAULT 'sharing' COMMENT '动态类型',
  `title` varchar(200) DEFAULT NULL COMMENT '标题',
  `content` text NOT NULL COMMENT '内容',
  `images` json DEFAULT NULL COMMENT '图片列表',
  `like_count` int DEFAULT 0 COMMENT '点赞数',
  `comment_count` int DEFAULT 0 COMMENT '评论数',
  `view_count` int DEFAULT 0 COMMENT '浏览数',
  `status` enum('published','draft','deleted') DEFAULT 'published' COMMENT '状态',
  `is_top` tinyint(1) DEFAULT 0 COMMENT '是否置顶',
  `publish_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '发布时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_publish_time` (`publish_time`),
  KEY `idx_is_top` (`is_top`),
  CONSTRAINT `fk_post_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='社区动态表';
```

### 5. 系统相关表

#### 5.1 管理员表 (admins)

```sql
CREATE TABLE `admins` (
  `id` varchar(50) NOT NULL COMMENT '管理员ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password_hash` varchar(255) NOT NULL COMMENT '密码哈希',
  `name` varchar(50) DEFAULT NULL COMMENT '姓名',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `role` enum('super_admin','admin','operator') DEFAULT 'admin' COMMENT '角色',
  `permissions` json DEFAULT NULL COMMENT '权限列表',
  `status` enum('active','inactive','locked') DEFAULT 'active' COMMENT '状态',
  `last_login_time` timestamp NULL DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(50) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` timestamp DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_status` (`status`),
  KEY `idx_role` (`role`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员表';
```

## 索引设计

### 主要索引说明

1. **主键索引**: 所有表都有主键索引，确保数据唯一性
2. **唯一索引**: 
   - users.open_id: 确保微信用户唯一
   - bookings.order_no: 确保订单号唯一
   - admins.username: 确保管理员用户名唯一

3. **复合索引**:
   - (user_id, record_time): 健康记录查询优化
   - (period_start, period_end): 健康报告时间范围查询

4. **外键索引**: 自动为外键创建索引，优化关联查询

## 数据字典

### 枚举值说明

| 表名 | 字段名 | 枚举值 | 说明 |
|------|--------|--------|------|
| users | gender | 男/女/未知 | 用户性别 |
| users | member_level | regular/vip | 会员等级 |
| users | status | active/inactive/frozen | 用户状态 |
| bookings | status | pending/confirmed/in_progress/completed/cancelled | 预约状态 |
| bookings | urgency | normal/urgent/emergency | 紧急程度 |
| health_records | source | self/nurse/device/doctor | 数据来源 |
| community_posts | type | health/experience/question/sharing | 动态类型 |

### JSON字段结构

#### 健康记录值 (health_records.value)
```json
{
  "bloodPressure": {
    "systolic": 120,
    "diastolic": 80
  },
  "bloodSugar": {
    "value": 5.6,
    "testType": "fasting"
  },
  "temperature": {
    "value": 36.5
  },
  "weight": {
    "value": 65.5
  }
}
```

#### 服务报告 (service_records.service_report)
```json
{
  "vitals": {
    "bloodPressure": "120/80",
    "heartRate": 72,
    "temperature": 36.5
  },
  "observations": "各项指标正常",
  "recommendations": ["保持规律作息", "适量运动"]
}
```

## 性能优化建议

### 1. 分区策略
- health_records表按月分区
- service_records表按年分区

### 2. 缓存策略
- 用户基本信息使用Redis缓存
- 热点健康数据缓存30分钟

### 3. 归档策略
- 超过2年的健康记录归档到历史表
- 删除状态的社区动态定期清理

---

**文档版本**: v1.0  
**创建时间**: 2025-08-25  
**维护人员**: 数据库管理员