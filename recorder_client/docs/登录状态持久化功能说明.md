# 登录状态持久化功能说明

## 概述

登录状态持久化功能为记录员小程序提供了完整的用户身份验证和状态管理解决方案。该功能确保用户登录状态在应用重启、页面切换等场景下能够自动恢复，提升用户体验。

## 核心功能

### 1. 自动登录检查机制
- 应用启动时自动检查本地存储的登录信息
- 验证Token有效性，确保登录状态可信
- 自动恢复用户状态到内存中

### 2. Token过期处理
- 支持客户端和服务端Token验证
- 自动检测Token过期并清理本地数据
- 在Token失效时引导用户重新登录

### 3. 登录状态同步
- 多页面间状态一致性保障
- 监听存储变化事件（如果支持）
- 页面显示时状态同步检查

### 4. 安全退出机制
- 清理所有本地存储的用户数据
- 重置全局状态变量
- 停止心跳检测和定时任务

### 5. 心跳检测
- 定期验证登录状态（每5分钟）
- 更新用户最后活跃时间
- 发现状态异常时自动处理

### 6. 页面权限保护
- 提供装饰器模式简化权限检查
- 自动拦截未登录用户访问
- 支持细粒度权限控制

## 架构设计

### 核心组件

1. **LoginStateManager** - 登录状态管理器
   - 负责登录状态的检查、恢复、同步
   - 提供Token验证和心跳检测
   - 处理强制退出和状态清理

2. **AppLoginInitializer** - 应用级登录初始化器
   - 应用启动时的登录状态初始化
   - 设置应用级事件监听
   - 提供登录状态摘要信息

3. **LoginPageDecorator** - 登录页面装饰器
   - 为页面添加自动登录检查
   - 提供快速装饰器方法
   - 支持权限控制

4. **UserInfoManager** - 用户信息管理器
   - 本地用户数据存储和管理
   - 用户偏好设置管理
   - 用户统计信息

## 使用方法

### 1. 基础页面登录检查

```javascript
// 使用装饰器为页面添加登录检查
const { LoginPageDecorator } = require('../../utils/login-page-decorator.js');

const MyPage = LoginPageDecorator.requireLogin({
  data: {
    // 页面数据
  },
  
  onLoad(options) {
    // 页面已通过登录检查，可以安全执行业务逻辑
    console.log('页面加载，用户已登录');
  }
});

Page(MyPage);
```

### 2. 带权限控制的页面

```javascript
const { LoginPageDecorator } = require('../../utils/login-page-decorator.js');
const { PERMISSIONS } = require('../../utils/role-permission.js');

const AdminPage = LoginPageDecorator.requirePermissions({
  data: {},
  
  onLoad(options) {
    console.log('管理员页面加载');
  }
}, [PERMISSIONS.ADMIN_ACCESS]);

Page(AdminPage);
```

### 3. 使用混入模式

```javascript
const { LoginStateMixin } = require('../../utils/login-page-decorator.js');

Page({
  // 混入登录状态管理方法
  ...LoginStateMixin,
  
  data: {},
  
  async onLoad(options) {
    // 手动检查登录状态
    const isLoggedIn = await this.checkLoginStatus();
    if (!isLoggedIn) {
      return;
    }
    
    // 业务逻辑
  },
  
  async handleLogout() {
    // 使用混入的退出方法
    await this.logout();
  }
});
```

### 4. 应用级状态管理

```javascript
// 在app.js中已经集成
const app = getApp();

// 检查登录状态
const loginState = app.getLoginStateInfo();
console.log('登录状态:', loginState);

// 同步登录状态
await app.syncLoginState();

// 预热登录检查
app.preWarmLoginCheck();
```

## 配置选项

### LoginPageDecorator 配置

```javascript
const pageObject = LoginPageDecorator.withLoginCheck({
  // 页面对象
}, {
  requiredPermissions: ['view_profile'], // 需要的权限
  autoRedirect: true,                    // 是否自动重定向
  onLoginRequired: function() {          // 登录需要时的回调
    console.log('需要登录');
  },
  onPermissionDenied: function(permissions) { // 权限不足时的回调
    console.log('权限不足:', permissions);
  }
});
```

### 心跳检测配置

心跳检测间隔在 `LoginStateManager` 中配置：

```javascript
// 默认5分钟检查一次
this.heartbeatTimer = setInterval(async () => {
  // 检查逻辑
}, 5 * 60 * 1000);
```

## API参考

### LoginStateManager

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| `init()` | 初始化登录状态管理器 | 无 | 无 |
| `checkAndRestoreLoginState()` | 检查并恢复登录状态 | 无 | Promise\<boolean\> |
| `checkLoginStatus(redirectToLogin)` | 检查登录状态 | redirectToLogin: boolean | Promise\<boolean\> |
| `validateToken(token)` | 验证Token | token: string | Promise\<boolean\> |
| `forceLogout(reason)` | 强制退出 | reason: string | Promise\<void\> |
| `logout()` | 主动退出 | 无 | Promise\<void\> |

### AppLoginInitializer

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| `initialize(app)` | 初始化应用登录状态 | app: Object | Promise\<boolean\> |
| `getLoginStateSummary()` | 获取登录状态摘要 | 无 | Object |
| `syncLoginState()` | 同步登录状态 | 无 | Promise\<void\> |
| `preWarmLoginCheck()` | 预热登录检查 | 无 | 无 |

### LoginPageDecorator

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| `withLoginCheck(pageObject, options)` | 装饰页面对象 | pageObject: Object, options: Object | Object |
| `requireLogin(pageObject)` | 快速登录检查装饰器 | pageObject: Object | Object |
| `requirePermissions(pageObject, permissions)` | 权限检查装饰器 | pageObject: Object, permissions: Array | Object |
| `requireAdmin(pageObject)` | 管理员权限装饰器 | pageObject: Object | Object |

## 事件系统

### 登录状态事件

应用支持以下登录状态事件：

- `restored` - 登录状态恢复
- `invalid` - 登录状态失效
- `logout` - 用户退出

### 事件监听

```javascript
// 在app.js中设置事件回调
AppLoginInitializer.setLoginEventCallback((type, data) => {
  console.log('登录事件:', type, data);
  
  switch (type) {
    case 'restored':
      // 处理登录恢复
      break;
    case 'invalid':
      // 处理登录失效
      break;
    case 'logout':
      // 处理用户退出
      break;
  }
});
```

## 安全考虑

### Token安全
- 本地存储使用微信小程序安全存储
- Token验证同时支持客户端和服务端
- 定期检查Token有效性

### 数据清理
- 退出时完全清理本地数据
- 状态失效时自动清理
- 防止敏感信息残留

### 权限控制
- 基于角色的权限管理
- 页面级权限控制
- API级权限验证

## 最佳实践

1. **统一使用装饰器** - 所有需要登录的页面都应使用装饰器
2. **合理设置权限** - 根据业务需求设置合适的权限级别
3. **及时处理异常** - 实现自定义的登录失效和权限不足处理
4. **监控登录状态** - 利用事件系统监控登录状态变化
5. **定期验证** - 利用心跳检测确保登录状态有效性

## 故障排除

### 常见问题

1. **登录状态丢失**
   - 检查本地存储是否被清理
   - 验证Token格式和有效期
   - 检查网络连接状态

2. **权限检查失败**
   - 确认用户角色设置正确
   - 检查权限配置是否匹配
   - 验证权限管理器初始化

3. **心跳检测异常**
   - 检查定时器是否正常运行
   - 验证网络API调用
   - 查看控制台错误信息

### 调试方法

```javascript
// 获取详细的登录状态信息
const loginState = LoginStateManager.getLoginStateInfo();
console.log('登录状态详情:', loginState);

// 手动同步状态
await LoginStateManager.syncLoginState();

// 检查用户统计
const userStats = UserInfoManager.getUserStats();
console.log('用户统计:', userStats);
```

## 更新日志

### v1.0.0 (2025-08-31)
- 实现基础登录状态持久化功能
- 添加Token验证和心跳检测
- 提供页面装饰器和权限控制
- 集成应用级状态管理
- 支持安全退出和状态同步