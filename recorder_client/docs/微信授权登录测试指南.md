# 微信授权登录功能测试指南

## 功能概述
微信授权登录功能已完成更新，支持最新的微信小程序授权规范，包含以下特性：
- 静默登录（无需用户授权的情况下直接登录）
- 用户信息授权（需要头像昵称时的授权流程）
- 手机号绑定（增强账户安全性）
- 完善的错误处理和用户引导

## 测试步骤

### 1. 基本功能测试

#### 1.1 静默登录测试
- **测试场景**: 用户首次使用或已授权的用户
- **操作步骤**: 
  1. 打开小程序登录页面
  2. 点击"微信登录"按钮
  3. 观察登录流程
- **预期结果**: 
  - 显示"微信登录中..."加载提示
  - 如果后端支持静默登录，直接跳转到首页
  - 如果需要用户信息，显示授权提示弹窗

#### 1.2 用户信息授权测试
- **测试场景**: 后端需要用户头像昵称信息
- **操作步骤**:
  1. 触发用户信息授权流程
  2. 点击"去授权"按钮
  3. 点击出现的绿色授权按钮
  4. 在授权弹窗中点击"允许"
- **预期结果**:
  - 显示授权提示弹窗
  - 出现绿色的"点击授权获取头像和昵称"按钮
  - 授权成功后继续登录流程

### 2. 手机号绑定测试

#### 2.1 绑定流程测试
- **测试场景**: 微信登录成功后需要绑定手机号
- **操作步骤**:
  1. 完成微信登录
  2. 在绑定手机号页面输入手机号
  3. 点击"获取验证码"
  4. 输入验证码
  5. 点击"确认绑定"
- **预期结果**:
  - 页面显示"绑定手机号"标题
  - 手机号格式验证正常
  - 验证码发送和倒计时功能正常
  - 绑定成功后跳转首页

#### 2.2 跳过绑定测试
- **测试场景**: 用户选择跳过手机号绑定
- **操作步骤**:
  1. 在绑定手机号页面点击"暂时跳过"
  2. 在确认弹窗中点击"确定跳过"
- **预期结果**:
  - 显示确认跳过的弹窗
  - 跳过后直接进入首页

### 3. 错误处理测试

#### 3.1 用户取消授权
- **操作步骤**: 在授权弹窗中点击"拒绝"
- **预期结果**: 显示"需要授权后才能使用微信登录"提示

#### 3.2 网络错误处理
- **操作步骤**: 在无网络状态下进行微信登录
- **预期结果**: 显示相应的网络错误提示

#### 3.3 验证码错误
- **操作步骤**: 在手机号绑定时输入错误验证码
- **预期结果**: 显示"验证码错误或已过期"提示

## 后端API要求

### 微信登录接口 `/auth/login/wechat`
**请求参数**:
```javascript
{
  "code": "微信登录code",
  "encryptedData": "用户信息加密数据（可选）",
  "iv": "初始向量（可选）",
  "signature": "数据签名（可选）",
  "rawData": "原始数据（可选）"
}
```

**响应格式**:
```javascript
// 静默登录成功
{
  "success": true,
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "用户token",
    "userInfo": {
      "id": "用户ID",
      "nickname": "用户昵称",
      "avatar": "用户头像",
      "phone": "手机号（可选）",
      "role": "用户角色"
    },
    "needBindPhone": false
  }
}

// 需要用户信息授权
{
  "success": false,
  "code": 1009,
  "message": "需要用户信息授权"
}

// 需要绑定手机号
{
  "success": true,
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "用户token",
    "userInfo": { /* 用户信息 */ },
    "needBindPhone": true
  }
}
```

### 绑定手机号接口 `/auth/bind-phone`
**请求参数**:
```javascript
{
  "phone": "手机号",
  "code": "验证码"
}
```

**响应格式**:
```javascript
{
  "success": true,
  "code": 0,
  "message": "绑定成功"
}
```

## 注意事项

1. **微信开发者工具测试**: 在开发者工具中，用户授权功能可能表现异常，建议在真机上测试
2. **授权按钮**: 由于小程序限制，用户信息授权必须通过button组件的open-type="getUserInfo"触发
3. **错误码处理**: 确保后端返回的错误码与前端处理逻辑匹配
4. **存储管理**: 成功登录后，token和用户信息会存储在本地，下次启动时会自动检查登录状态

## 文件清单

已更新/创建的文件：
- `pages/login/login.js` - 更新微信登录逻辑
- `pages/login/login.wxml` - 添加隐藏授权按钮
- `pages/login/login.wxss` - 添加授权按钮样式
- `pages/bind-phone/bind-phone.js` - 手机号绑定页面逻辑
- `pages/bind-phone/bind-phone.wxml` - 手机号绑定页面结构
- `pages/bind-phone/bind-phone.wxss` - 手机号绑定页面样式
- `pages/bind-phone/bind-phone.json` - 手机号绑定页面配置
- `api/index.js` - 更新微信登录API和添加绑定手机号API
- `app.json` - 注册新页面