<view class="schedule-page">
  <view class="page-header">
    <text class="page-title">日程管理</text>
  </view>
  
  <view class="page-content">
    <!-- 统计概览 -->
    <view class="stats-section">
      <text class="stats-title">统计信息</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{statistics.total}}</text>
          <text class="stat-label">总日程</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.today}}</text>
          <text class="stat-label">今日</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.pending}}</text>
          <text class="stat-label">待服务</text>
        </view>
      </view>
    </view>
    
    <!-- 日程列表 - 新版卡片式设计 -->
    <view class="schedule-section">
      <!-- 列表头部信息 -->
      <view class="list-header">
        <view class="header-left">
          <text class="list-title">日程安排</text>
          <text wx:if="{{filteredScheduleList.length > 0}}" class="list-count">
            共{{filteredScheduleList.length}}项
          </text>
        </view>
        <view class="header-actions">
          <view class="action-btn" bindtap="onFilterTap">
            <text class="action-icon">🔍</text>
            <text class="action-text">筛选</text>
          </view>
          <view class="action-btn" bindtap="onSortTap">
            <text class="action-icon">⏰</text>
            <text class="action-text">排序</text>
          </view>
        </view>
      </view>
      
      <!-- 快速筛选标签 -->
      <scroll-view wx:if="{{filteredScheduleList.length > 0}}" 
                   class="quick-filters-scroll" 
                   scroll-x="true" 
                   show-scrollbar="false">
        <view class="quick-filters-list">
          <view wx:for="{{quickFilters}}" wx:key="key"
                class="filter-tag {{currentFilters.time === item.key || currentFilters.status === item.key ? 'active' : ''}}"
                data-key="{{item.key}}"
                bindtap="onQuickFilter">
            <text class="filter-icon">{{item.icon}}</text>
            <text class="filter-label">{{item.label}}</text>
            <text wx:if="{{item.count > 0}}" class="filter-count">{{item.count}}</text>
          </view>
        </view>
      </scroll-view>
      
      <!-- 加载骨架屏 -->
      <view wx:if="{{loading}}" class="loading-skeleton">
        <view wx:for="{{[1,2,3,4]}}" wx:key="*this" class="skeleton-card">
          <view class="skeleton-header">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-info">
              <view class="skeleton-line skeleton-title"></view>
              <view class="skeleton-line skeleton-subtitle"></view>
            </view>
            <view class="skeleton-status"></view>
          </view>
          <view class="skeleton-content">
            <view class="skeleton-line skeleton-detail"></view>
            <view class="skeleton-line skeleton-detail short"></view>
          </view>
        </view>
      </view>
      
      <!-- 空状态 -->
      <view wx:elif="{{filteredScheduleList.length === 0 && !loading}}" class="empty-state-new">
        <view class="empty-animation">
          <text class="empty-icon-large">📅</text>
          <view class="empty-wave"></view>
        </view>
        <text class="empty-title-new">暂无日程安排</text>
        <text class="empty-subtitle-new">
          {{
            currentFilters.time !== 'all' || currentFilters.status !== 'all' 
            ? '当前筛选条件下没有找到相关日程' 
            : '您还没有添加任何日程安排'
          }}
        </text>
        <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all'}}" 
              class="empty-actions">
          <view class="empty-btn primary" bindtap="clearFilters">
            <text class="btn-icon">🔄</text>
            <text class="btn-text">清除筛选</text>
          </view>
        </view>
        <view wx:else class="empty-actions">
          <view class="empty-btn primary" bindtap="addSchedule">
            <text class="btn-icon">➕</text>
            <text class="btn-text">添加日程</text>
          </view>
        </view>
      </view>
      
      <!-- 错误状态 -->
      <view wx:elif="{{errorState.hasError}}" class="error-state-new">
        <view class="error-animation">
          <text class="error-icon-large">⚠️</text>
          <view class="error-pulse"></view>
        </view>
        <text class="error-title-new">加载失败</text>
        <text class="error-message-new">{{errorState.errorMessage || '网络连接异常，请检查网络后重试'}}</text>
        <view class="error-actions-new">
          <view wx:if="{{errorState.canRetry && errorState.retryCount < errorState.maxRetry}}" 
                class="error-btn-new retry"
                bindtap="retryLastOperation">
            <text class="btn-icon">🔄</text>
            <text class="btn-text">重试</text>
          </view>
          <view class="error-btn-new reload" bindtap="manualReload">
            <text class="btn-icon">🔄</text>
            <text class="btn-text">重新加载</text>
          </view>
        </view>
      </view>
      
      <!-- 日程卡片列表 -->
      <view wx:else class="schedule-cards">
        <view wx:for="{{filteredScheduleList}}" 
              wx:key="id" 
              class="schedule-card {{item.status === 'urgent' ? 'urgent' : item.status === 'overdue' ? 'overdue' : ''}}"
              data-id="{{item.id}}"
              bindtap="onScheduleItemTap"
              bindlongpress="onScheduleItemLongPress">
          
          <!-- 卡片头部 -->
          <view class="card-header">
            <view class="patient-avatar">
              <text class="avatar-text">{{item.patientName.charAt(0)}}</text>
            </view>
            <view class="card-info">
              <text class="patient-name-new">{{item.patientName}}</text>
              <text class="service-name">{{item.serviceName || '健康服务'}}</text>
            </view>
            <view class="status-badge status-{{item.status}}">
              <text class="status-text">{{item.statusText || item.status}}</text>
            </view>
          </view>
          
          <!-- 时间信息 -->
          <view class="card-time">
            <view class="time-info">
              <text class="time-icon">🕒</text>
              <text class="time-text">{{item.startTimeFormatted || item.startTime}}</text>
            </view>
            <view wx:if="{{item.estimatedDuration}}" class="duration-info">
              <text class="duration-icon">⏱️</text>
              <text class="duration-text">预计{{item.estimatedDuration}}分钟</text>
            </view>
          </view>
          
          <!-- 地址信息 -->
          <view wx:if="{{item.address}}" class="card-address">
            <text class="address-icon">📍</text>
            <text class="address-text">{{item.address}}</text>
          </view>
          
          <!-- 备注信息 -->
          <view wx:if="{{item.notes}}" class="card-notes">
            <text class="notes-icon">📝</text>
            <text class="notes-text">{{item.notes}}</text>
          </view>
          
          <!-- 卡片底部操作 -->
          <view class="card-actions">
            <view wx:if="{{item.priority === 'urgent'}}" class="priority-tag urgent">
              <text class="priority-icon">🔥</text>
              <text class="priority-text">紧急</text>
            </view>
            <view wx:elif="{{item.priority === 'high'}}" class="priority-tag high">
              <text class="priority-icon">⚡</text>
              <text class="priority-text">重要</text>
            </view>
            
            <view class="action-buttons">
              <view wx:if="{{item.status === 'pending'}}" 
                    class="action-btn-mini start"
                    data-id="{{item.id}}"
                    catchtap="onStartService">
                <text class="btn-icon-mini">▶️</text>
                <text class="btn-text-mini">开始</text>
              </view>
              <view class="action-btn-mini more"
                    data-id="{{item.id}}"
                    catchtap="onShowMoreActions">
                <text class="btn-icon-mini">⋯</text>
              </view>
            </view>
          </view>
          
          <!-- 选中状态 -->
          <view wx:if="{{batchMode}}" class="selection-indicator">
            <view class="selection-checkbox {{selectedSchedules.indexOf(item.id) !== -1 ? 'checked' : ''}}"
                  data-id="{{item.id}}"
                  catchtap="onToggleSelection">
              <text wx:if="{{selectedSchedules.indexOf(item.id) !== -1}}" class="check-icon">✓</text>
            </view>
          </view>
        </view>
        
        <!-- 加载更多 -->
        <view wx:if="{{loadingMore}}" class="loading-more-new">
          <view class="loading-spinner-new"></view>
          <text class="loading-text-new">加载更多日程...</text>
        </view>
        
        <!-- 无更多数据 -->
        <view wx:elif="{{!hasMore && filteredScheduleList.length > 0}}" class="no-more-new">
          <view class="divider-line"></view>
          <text class="no-more-text-new">已显示全部日程</text>
          <view class="divider-line"></view>
        </view>
      </view>
    </view>
    
    <!-- 批量操作面板 -->
    <view wx:if="{{batchMode && selectedSchedules.length > 0}}" class="batch-actions-panel">
      <view class="batch-info">
        <text class="batch-count">已选择 {{selectedSchedules.length}} 项</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn" data-action="reschedule" bindtap="onBatchAction">
          <text class="batch-icon">📅</text>
          <text class="batch-text">批量调整</text>
        </view>
        <view class="batch-btn" data-action="cancel" bindtap="onBatchAction">
          <text class="batch-icon">❌</text>
          <text class="batch-text">批量取消</text>
        </view>
        <view class="batch-btn" data-action="confirm" bindtap="onBatchAction">
          <text class="batch-icon">✅</text>
          <text class="batch-text">批量确认</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 浮动操作按钮 -->
  <view class="fab-container">
    <view class="fab-btn" bindtap="addSchedule">
      <text class="fab-icon">+</text>
    </view>
  </view>
  
  <!-- 筛选器组件 -->
  <schedule-filter 
    visible="{{showFilter}}"
    filters="{{currentFilters}}"
    bind:filter="onFilterChange">
  </schedule-filter>
  
  <!-- 操作弹窗 -->
  <modal
    visible="{{showActionModal}}"
    title="选择操作"
    bind:close="onActionModalClose">
    <view slot="content" class="action-modal-content">
      <view wx:for="{{actionModalActions}}" wx:key="key"
            class="action-modal-item"
            data-action="{{item.key}}"
            bindtap="onScheduleAction">
        <text class="action-modal-icon">{{item.icon}}</text>
        <text class="action-modal-text">{{item.label}}</text>
      </view>
    </view>
  </modal>
  
  <!-- 时间调整弹窗 -->
  <time-adjust-modal
    visible="{{timeAdjustment.modalVisible}}"
    appointmentInfo="{{timeAdjustment.currentAppointment}}"
    isBatch="{{timeAdjustment.isBatch}}"
    batchAppointments="{{timeAdjustment.batchAppointments}}"
    availableSlots="{{timeAdjustment.availableSlots}}"
    bind:success="onTimeAdjustSuccess"
    bind:cancel="onTimeAdjustCancel"
    bind:close="hideTimeAdjustModal">
  </time-adjust-modal>
  
  <!-- 调整历史弹窗 -->
  <modal
    visible="{{timeAdjustment.adjustmentHistory.modalVisible}}"
    title="调整历史"
    type="fullscreen"
    bind:close="onCloseAdjustmentHistory">
    <adjustment-history
      appointmentId="{{timeAdjustment.adjustmentHistory.appointmentId}}"
      recorderId="{{timeAdjustment.adjustmentHistory.recorderId}}"
      bind:reapply="onReapplyAdjustment">
    </adjustment-history>
  </modal>
  
  <!-- 审批管理组件 -->
  <approval-manager
    show="{{approvalManagement.modalVisible}}"
    mode="{{approvalManagement.mode}}"
    request-id="{{approvalManagement.currentRequestId}}"
    user-role="{{approvalManagement.userRole}}"
    bind:view-detail="viewApprovalDetail"
    bind:approval-complete="onApprovalComplete"
    bind:close="closeApprovalManager">
  </approval-manager>
</view>