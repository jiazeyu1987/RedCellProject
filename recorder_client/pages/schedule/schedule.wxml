<view class="schedule-page">
  <view class="page-header">
    <text class="page-title">æ—¥ç¨‹ç®¡ç†</text>
  </view>
  
  <view class="page-content">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="stats-section">
      <text class="stats-title">ç»Ÿè®¡ä¿¡æ¯</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{statistics.total}}</text>
          <text class="stat-label">æ€»æ—¥ç¨‹</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.today}}</text>
          <text class="stat-label">ä»Šæ—¥</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.pending}}</text>
          <text class="stat-label">å¾…æœåŠ¡</text>
        </view>
      </view>
    </view>
    
    <!-- æ—¥ç¨‹åˆ—è¡¨ - æ–°ç‰ˆå¡ç‰‡å¼è®¾è®¡ -->
    <view class="schedule-section">
      <!-- åˆ—è¡¨å¤´éƒ¨ä¿¡æ¯ -->
      <view class="list-header">
        <view class="header-left">
          <text class="list-title">æ—¥ç¨‹å®‰æ’</text>
          <text wx:if="{{filteredScheduleList.length > 0}}" class="list-count">
            å…±{{filteredScheduleList.length}}é¡¹
          </text>
        </view>
        <view class="header-actions">
          <view class="action-btn" bindtap="onFilterTap">
            <text class="action-icon">ğŸ”</text>
            <text class="action-text">ç­›é€‰</text>
          </view>
          <view class="action-btn" bindtap="onSortTap">
            <text class="action-icon">â°</text>
            <text class="action-text">æ’åº</text>
          </view>
        </view>
      </view>
      
      <!-- å¿«é€Ÿç­›é€‰æ ‡ç­¾ -->
      <scroll-view wx:if="{{filteredScheduleList.length > 0}}" 
                   class="quick-filters-scroll" 
                   scroll-x="true" 
                   show-scrollbar="false">
        <view class="quick-filters-list">
          <view wx:for="{{quickFilters}}" wx:key="key"
                class="filter-tag {{currentFilters.time === item.key || currentFilters.status === item.key ? 'active' : ''}}"
                data-key="{{item.key}}"
                bindtap="onQuickFilter">
            <text class="filter-icon">{{item.icon}}</text>
            <text class="filter-label">{{item.label}}</text>
            <text wx:if="{{item.count > 0}}" class="filter-count">{{item.count}}</text>
          </view>
        </view>
      </scroll-view>
      
      <!-- åŠ è½½éª¨æ¶å± -->
      <view wx:if="{{loading}}" class="loading-skeleton">
        <view wx:for="{{[1,2,3,4]}}" wx:key="*this" class="skeleton-card">
          <view class="skeleton-header">
            <view class="skeleton-avatar"></view>
            <view class="skeleton-info">
              <view class="skeleton-line skeleton-title"></view>
              <view class="skeleton-line skeleton-subtitle"></view>
            </view>
            <view class="skeleton-status"></view>
          </view>
          <view class="skeleton-content">
            <view class="skeleton-line skeleton-detail"></view>
            <view class="skeleton-line skeleton-detail short"></view>
          </view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{filteredScheduleList.length === 0 && !loading}}" class="empty-state-new">
        <view class="empty-animation">
          <text class="empty-icon-large">ğŸ“…</text>
          <view class="empty-wave"></view>
        </view>
        <text class="empty-title-new">æš‚æ— æ—¥ç¨‹å®‰æ’</text>
        <text class="empty-subtitle-new">
          {{
            currentFilters.time !== 'all' || currentFilters.status !== 'all' 
            ? 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥ç¨‹' 
            : 'æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•æ—¥ç¨‹å®‰æ’'
          }}
        </text>
        <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all'}}" 
              class="empty-actions">
          <view class="empty-btn primary" bindtap="clearFilters">
            <text class="btn-icon">ğŸ”„</text>
            <text class="btn-text">æ¸…é™¤ç­›é€‰</text>
          </view>
        </view>
        <view wx:else class="empty-actions">
          <view class="empty-btn primary" bindtap="addSchedule">
            <text class="btn-icon">â•</text>
            <text class="btn-text">æ·»åŠ æ—¥ç¨‹</text>
          </view>
        </view>
      </view>
      
      <!-- é”™è¯¯çŠ¶æ€ -->
      <view wx:elif="{{errorState.hasError}}" class="error-state-new">
        <view class="error-animation">
          <text class="error-icon-large">âš ï¸</text>
          <view class="error-pulse"></view>
        </view>
        <text class="error-title-new">åŠ è½½å¤±è´¥</text>
        <text class="error-message-new">{{errorState.errorMessage || 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'}}</text>
        <view class="error-actions-new">
          <view wx:if="{{errorState.canRetry && errorState.retryCount < errorState.maxRetry}}" 
                class="error-btn-new retry"
                bindtap="retryLastOperation">
            <text class="btn-icon">ğŸ”„</text>
            <text class="btn-text">é‡è¯•</text>
          </view>
          <view class="error-btn-new reload" bindtap="manualReload">
            <text class="btn-icon">ğŸ”„</text>
            <text class="btn-text">é‡æ–°åŠ è½½</text>
          </view>
        </view>
      </view>
      
      <!-- æ—¥ç¨‹å¡ç‰‡åˆ—è¡¨ -->
      <view wx:else class="schedule-cards">
        <view wx:for="{{filteredScheduleList}}" 
              wx:key="id" 
              class="schedule-card {{item.status === 'urgent' ? 'urgent' : item.status === 'overdue' ? 'overdue' : ''}}"
              data-id="{{item.id}}"
              bindtap="onScheduleItemTap"
              bindlongpress="onScheduleItemLongPress">
          
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="patient-avatar">
              <text class="avatar-text">{{item.patientName.charAt(0)}}</text>
            </view>
            <view class="card-info">
              <text class="patient-name-new">{{item.patientName}}</text>
              <text class="service-name">{{item.serviceName || 'å¥åº·æœåŠ¡'}}</text>
            </view>
            <view class="status-badge status-{{item.status}}">
              <text class="status-text">{{item.statusText || item.status}}</text>
            </view>
          </view>
          
          <!-- æ—¶é—´ä¿¡æ¯ -->
          <view class="card-time">
            <view class="time-info">
              <text class="time-icon">ğŸ•’</text>
              <text class="time-text">{{item.startTimeFormatted || item.startTime}}</text>
            </view>
            <view wx:if="{{item.estimatedDuration}}" class="duration-info">
              <text class="duration-icon">â±ï¸</text>
              <text class="duration-text">é¢„è®¡{{item.estimatedDuration}}åˆ†é’Ÿ</text>
            </view>
          </view>
          
          <!-- åœ°å€ä¿¡æ¯ -->
          <view wx:if="{{item.address}}" class="card-address">
            <text class="address-icon">ğŸ“</text>
            <text class="address-text">{{item.address}}</text>
          </view>
          
          <!-- å¤‡æ³¨ä¿¡æ¯ -->
          <view wx:if="{{item.notes}}" class="card-notes">
            <text class="notes-icon">ğŸ“</text>
            <text class="notes-text">{{item.notes}}</text>
          </view>
          
          <!-- å¡ç‰‡åº•éƒ¨æ“ä½œ -->
          <view class="card-actions">
            <view wx:if="{{item.priority === 'urgent'}}" class="priority-tag urgent">
              <text class="priority-icon">ğŸ”¥</text>
              <text class="priority-text">ç´§æ€¥</text>
            </view>
            <view wx:elif="{{item.priority === 'high'}}" class="priority-tag high">
              <text class="priority-icon">âš¡</text>
              <text class="priority-text">é‡è¦</text>
            </view>
            
            <view class="action-buttons">
              <view wx:if="{{item.status === 'pending'}}" 
                    class="action-btn-mini start"
                    data-id="{{item.id}}"
                    catchtap="onStartService">
                <text class="btn-icon-mini">â–¶ï¸</text>
                <text class="btn-text-mini">å¼€å§‹</text>
              </view>
              <view class="action-btn-mini more"
                    data-id="{{item.id}}"
                    catchtap="onShowMoreActions">
                <text class="btn-icon-mini">â‹¯</text>
              </view>
            </view>
          </view>
          
          <!-- é€‰ä¸­çŠ¶æ€ -->
          <view wx:if="{{batchMode}}" class="selection-indicator">
            <view class="selection-checkbox {{selectedSchedules.indexOf(item.id) !== -1 ? 'checked' : ''}}"
                  data-id="{{item.id}}"
                  catchtap="onToggleSelection">
              <text wx:if="{{selectedSchedules.indexOf(item.id) !== -1}}" class="check-icon">âœ“</text>
            </view>
          </view>
        </view>
        
        <!-- åŠ è½½æ›´å¤š -->
        <view wx:if="{{loadingMore}}" class="loading-more-new">
          <view class="loading-spinner-new"></view>
          <text class="loading-text-new">åŠ è½½æ›´å¤šæ—¥ç¨‹...</text>
        </view>
        
        <!-- æ— æ›´å¤šæ•°æ® -->
        <view wx:elif="{{!hasMore && filteredScheduleList.length > 0}}" class="no-more-new">
          <view class="divider-line"></view>
          <text class="no-more-text-new">å·²æ˜¾ç¤ºå…¨éƒ¨æ—¥ç¨‹</text>
          <view class="divider-line"></view>
        </view>
      </view>
    </view>
    
    <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
    <view wx:if="{{batchMode && selectedSchedules.length > 0}}" class="batch-actions-panel">
      <view class="batch-info">
        <text class="batch-count">å·²é€‰æ‹© {{selectedSchedules.length}} é¡¹</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn" data-action="reschedule" bindtap="onBatchAction">
          <text class="batch-icon">ğŸ“…</text>
          <text class="batch-text">æ‰¹é‡è°ƒæ•´</text>
        </view>
        <view class="batch-btn" data-action="cancel" bindtap="onBatchAction">
          <text class="batch-icon">âŒ</text>
          <text class="batch-text">æ‰¹é‡å–æ¶ˆ</text>
        </view>
        <view class="batch-btn" data-action="confirm" bindtap="onBatchAction">
          <text class="batch-icon">âœ…</text>
          <text class="batch-text">æ‰¹é‡ç¡®è®¤</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-btn" bindtap="addSchedule">
      <text class="fab-icon">+</text>
    </view>
  </view>
  
  <!-- ç­›é€‰å™¨ç»„ä»¶ -->
  <schedule-filter 
    visible="{{showFilter}}"
    filters="{{currentFilters}}"
    bind:filter="onFilterChange">
  </schedule-filter>
  
  <!-- æ“ä½œå¼¹çª— -->
  <modal
    visible="{{showActionModal}}"
    title="é€‰æ‹©æ“ä½œ"
    bind:close="onActionModalClose">
    <view slot="content" class="action-modal-content">
      <view wx:for="{{actionModalActions}}" wx:key="key"
            class="action-modal-item"
            data-action="{{item.key}}"
            bindtap="onScheduleAction">
        <text class="action-modal-icon">{{item.icon}}</text>
        <text class="action-modal-text">{{item.label}}</text>
      </view>
    </view>
  </modal>
  
  <!-- æ—¶é—´è°ƒæ•´å¼¹çª— -->
  <time-adjust-modal
    visible="{{timeAdjustment.modalVisible}}"
    appointmentInfo="{{timeAdjustment.currentAppointment}}"
    isBatch="{{timeAdjustment.isBatch}}"
    batchAppointments="{{timeAdjustment.batchAppointments}}"
    availableSlots="{{timeAdjustment.availableSlots}}"
    bind:success="onTimeAdjustSuccess"
    bind:cancel="onTimeAdjustCancel"
    bind:close="hideTimeAdjustModal">
  </time-adjust-modal>
  
  <!-- è°ƒæ•´å†å²å¼¹çª— -->
  <modal
    visible="{{timeAdjustment.adjustmentHistory.modalVisible}}"
    title="è°ƒæ•´å†å²"
    type="fullscreen"
    bind:close="onCloseAdjustmentHistory">
    <adjustment-history
      appointmentId="{{timeAdjustment.adjustmentHistory.appointmentId}}"
      recorderId="{{timeAdjustment.adjustmentHistory.recorderId}}"
      bind:reapply="onReapplyAdjustment">
    </adjustment-history>
  </modal>
  
  <!-- å®¡æ‰¹ç®¡ç†ç»„ä»¶ -->
  <approval-manager
    show="{{approvalManagement.modalVisible}}"
    mode="{{approvalManagement.mode}}"
    request-id="{{approvalManagement.currentRequestId}}"
    user-role="{{approvalManagement.userRole}}"
    bind:view-detail="viewApprovalDetail"
    bind:approval-complete="onApprovalComplete"
    bind:close="closeApprovalManager">
  </approval-manager>
</view>