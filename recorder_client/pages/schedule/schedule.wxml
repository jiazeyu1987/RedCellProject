<!--日程管理页面-->
<view class="schedule-page">
  
  <!-- 页面顶部导航区域 -->
  <view class="page-header">
    <!-- 标题和操作区域 -->
    <view class="header-top">
      <view class="header-left">
        <text class="page-title">日程管理</text>
        <text class="page-subtitle" wx:if="{{scheduleStats.total > 0}}">
          共{{scheduleStats.total}}个日程
        </text>
      </view>
      <view class="header-right">
        <!-- 批量操作切换 -->
        <view class="action-btn" wx:if="{{permissions.canBatchEdit && scheduleList.length > 0}}" 
              bindtap="toggleBatchMode">
          <text class="action-icon">{{batchMode ? '✓' : '☰'}}</text>
          <text class="action-text">{{batchMode ? '完成' : '选择'}}</text>
        </view>
        
        <!-- 筛选器切换 -->
        <view class="action-btn" bindtap="toggleFilter">
          <text class="action-icon">🔍</text>
          <text class="action-text">筛选</text>
          <view class="filter-badge" wx:if="{{hasActiveFilters}}"></view>
        </view>
        
        <!-- 更多操作菜单 -->
        <view class="action-btn" bindtap="showMoreMenu">
          <text class="action-icon">⋯</text>
        </view>
      </view>
    </view>
    
    <!-- 统计信息栏 -->
    <view class="stats-bar" wx:if="{{showStats && scheduleStats.total > 0}}">
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.today}}</text>
        <text class="stat-label">今日</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.pending}}</text>
        <text class="stat-label">待服务</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.completed}}</text>
        <text class="stat-label">已完成</text>
      </view>
      <view class="stat-item" wx:if="{{scheduleStats.overdue > 0}}">
        <text class="stat-number overdue">{{scheduleStats.overdue}}</text>
        <text class="stat-label">已过期</text>
      </view>
    </view>
  </view>

  <!-- 快捷筛选标签区域 -->
  <view class="quick-filters" wx:if="{{!batchMode}}">
    <scroll-view class="filter-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
      <view class="filter-tags">
        <view class="filter-tag {{item.active ? 'active' : ''}}" 
              wx:for="{{quickFilters}}" 
              wx:key="key"
              data-filter="{{item.key}}"
              bindtap="onQuickFilter">
          <text class="tag-icon">{{item.icon}}</text>
          <text class="tag-label">{{item.label}}</text>
          <text class="tag-count" wx:if="{{item.count > 0}}">{{item.count}}</text>
        </view>
        
        <!-- 自定义筛选入口 -->
        <view class="filter-tag custom" bindtap="showCustomFilter">
          <text class="tag-icon">🎛️</text>
          <text class="tag-label">高级筛选</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 批量操作工具栏 -->
  <view class="batch-toolbar" wx:if="{{batchMode}}">
    <view class="batch-left">
      <checkbox class="select-all-checkbox" 
                checked="{{allSelected}}" 
                bindtap="toggleSelectAll">
        全选
      </checkbox>
      <text class="selected-count">已选择 {{selectedSchedules.length}} 项</text>
    </view>
    <view class="batch-right">
      <button class="batch-btn" 
              disabled="{{selectedSchedules.length === 0}}"
              bindtap="batchReschedule">
        <text class="btn-icon">📅</text>
        <text>改期</text>
      </button>
      <button class="batch-btn" 
              disabled="{{selectedSchedules.length === 0}}"
              bindtap="batchCancel">
        <text class="btn-icon">❌</text>
        <text>取消</text>
      </button>
    </view>
  </view>

  <!-- 主内容区域 -->
  <view class="page-content">
    
    <!-- 加载骨架屏 -->
    <loading-skeleton wx:if="{{loading && scheduleList.length === 0}}" 
                      type="schedule-list" 
                      count="5" />
    
    <!-- 日程列表 -->
    <view class="schedule-list" wx:if="{{!loading || scheduleList.length > 0}}">
      <view class="list-container">
        
        <!-- 刷新提示 -->
        <view class="refresh-tip" wx:if="{{refreshing}}">
          <text class="refresh-icon">🔄</text>
          <text class="refresh-text">正在刷新...</text>
        </view>
        
        <!-- 日程卡片列表 -->
        <view class="schedule-items">
          <schedule-card wx:for="{{filteredScheduleList}}" 
                        wx:key="id"
                        schedule="{{item}}"
                        selectable="{{batchMode}}"
                        selected="{{selectedSchedules.includes(item.id)}}"
                        card-type="default"
                        show-actions="{{!batchMode && permissions.canEdit}}"
                        data-schedule="{{item}}"
                        bind:tap="onScheduleTap"
                        bind:select="onScheduleSelect"
                        bind:action="onScheduleAction"
                        custom-class="schedule-item" />
        </view>
        
        <!-- 加载更多指示器 -->
        <view class="load-more" wx:if="{{loadingMore}}">
          <text class="load-more-icon">⏳</text>
          <text class="load-more-text">加载更多...</text>
        </view>
        
        <!-- 没有更多数据提示 -->
        <view class="no-more" wx:if="{{!pagination.hasMore && filteredScheduleList.length > 0}}">
          <text class="no-more-text">已显示全部日程</text>
        </view>
      </view>
    </view>
    
    <!-- 空状态展示 -->
    <empty-state wx:if="{{!loading && filteredScheduleList.length === 0}}"
                type="schedule"
                title="暂无日程安排"
                description="{{hasActiveFilters ? '当前筛选条件下没有找到日程' : '还没有创建任何日程安排'}}"
                button-text="{{hasActiveFilters ? '清除筛选' : '创建日程'}}"
                bind:action="onEmptyAction" />
  </view>

  <!-- 浮动操作按钮 -->
  <view class="fab-container" wx:if="{{showFab && !batchMode && permissions.canEdit}}">
    <view class="fab-main" bindtap="toggleFab">
      <text class="fab-icon">{{fabExpanded ? '✕' : '➕'}}</text>
    </view>
    
    <!-- 展开的操作按钮 -->
    <view class="fab-actions {{fabExpanded ? 'expanded' : ''}}" wx:if="{{fabExpanded}}">
      <view class="fab-action" 
            wx:for="{{fabActions}}" 
            wx:key="key"
            data-action="{{item.key}}"
            bindtap="onFabAction"
            style="background-color: {{item.color}}">
        <text class="fab-action-icon">{{item.icon}}</text>
        <text class="fab-action-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- 筛选器组件 -->
  <schedule-filter wx:if="{{showFilter}}"
                  visible="{{showFilter}}"
                  filters="{{currentFilters}}"
                  patient-list="{{patientList}}"
                  bind:filter="onFilterChange"
                  bind:close="hideFilter"
                  bind:reset="onFilterReset" />

  <!-- 更多操作菜单 -->
  <modal wx:if="{{showMoreMenu}}"
         visible="{{showMoreMenu}}"
         title="更多操作"
         bind:close="hideMoreMenu">
    <view slot="content" class="more-menu">
      <view class="menu-item" bindtap="exportSchedule">
        <text class="menu-icon">📤</text>
        <text class="menu-text">导出日程</text>
      </view>
      <view class="menu-item" bindtap="syncSchedule">
        <text class="menu-icon">🔄</text>
        <text class="menu-text">同步日程</text>
      </view>
      <view class="menu-item" bindtap="scheduleSettings">
        <text class="menu-icon">⚙️</text>
        <text class="menu-text">日程设置</text>
      </view>
    </view>
  </modal>

</view>