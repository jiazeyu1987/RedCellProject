<!--æ—¥ç¨‹ç®¡ç†é¡µé¢-->
<view class="schedule-page">
  
  <!-- é¡µé¢é¡¶éƒ¨å¯¼èˆªåŒºåŸŸ -->
  <view class="page-header">
    <!-- æ ‡é¢˜å’Œæ“ä½œåŒºåŸŸ -->
    <view class="header-top">
      <view class="header-left">
        <text class="page-title">æ—¥ç¨‹ç®¡ç†</text>
        <text class="page-subtitle" wx:if="{{scheduleStats.total > 0}}">
          å…±{{scheduleStats.total}}ä¸ªæ—¥ç¨‹
        </text>
      </view>
      <view class="header-right">
        <!-- æ‰¹é‡æ“ä½œåˆ‡æ¢ -->
        <view class="action-btn" wx:if="{{permissions.canBatchEdit && scheduleList.length > 0}}" 
              bindtap="toggleBatchMode">
          <text class="action-icon">{{batchMode ? 'âœ“' : 'â˜°'}}</text>
          <text class="action-text">{{batchMode ? 'å®Œæˆ' : 'é€‰æ‹©'}}</text>
        </view>
        
        <!-- ç­›é€‰å™¨åˆ‡æ¢ -->
        <view class="action-btn" bindtap="toggleFilter">
          <text class="action-icon">ğŸ”</text>
          <text class="action-text">ç­›é€‰</text>
          <view class="filter-badge" wx:if="{{hasActiveFilters}}"></view>
        </view>
        
        <!-- æ›´å¤šæ“ä½œèœå• -->
        <view class="action-btn" bindtap="showMoreMenu">
          <text class="action-icon">â‹¯</text>
        </view>
      </view>
    </view>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯æ  -->
    <view class="stats-bar" wx:if="{{showStats && scheduleStats.total > 0}}">
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.today}}</text>
        <text class="stat-label">ä»Šæ—¥</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.pending}}</text>
        <text class="stat-label">å¾…æœåŠ¡</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{scheduleStats.completed}}</text>
        <text class="stat-label">å·²å®Œæˆ</text>
      </view>
      <view class="stat-item" wx:if="{{scheduleStats.overdue > 0}}">
        <text class="stat-number overdue">{{scheduleStats.overdue}}</text>
        <text class="stat-label">å·²è¿‡æœŸ</text>
      </view>
    </view>
  </view>

  <!-- å¿«æ·ç­›é€‰æ ‡ç­¾åŒºåŸŸ -->
  <view class="quick-filters" wx:if="{{!batchMode}}">
    <scroll-view class="filter-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
      <view class="filter-tags">
        <view class="filter-tag {{item.active ? 'active' : ''}}" 
              wx:for="{{quickFilters}}" 
              wx:key="key"
              data-filter="{{item.key}}"
              bindtap="onQuickFilter">
          <text class="tag-icon">{{item.icon}}</text>
          <text class="tag-label">{{item.label}}</text>
          <text class="tag-count" wx:if="{{item.count > 0}}">{{item.count}}</text>
        </view>
        
        <!-- è‡ªå®šä¹‰ç­›é€‰å…¥å£ -->
        <view class="filter-tag custom" bindtap="showCustomFilter">
          <text class="tag-icon">ğŸ›ï¸</text>
          <text class="tag-label">é«˜çº§ç­›é€‰</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
  <view class="batch-toolbar" wx:if="{{batchMode}}">
    <view class="batch-left">
      <checkbox class="select-all-checkbox" 
                checked="{{allSelected}}" 
                bindtap="toggleSelectAll">
        å…¨é€‰
      </checkbox>
      <text class="selected-count">å·²é€‰æ‹© {{selectedSchedules.length}} é¡¹</text>
    </view>
    <view class="batch-right">
      <button class="batch-btn" 
              disabled="{{selectedSchedules.length === 0}}"
              bindtap="batchReschedule">
        <text class="btn-icon">ğŸ“…</text>
        <text>æ”¹æœŸ</text>
      </button>
      <button class="batch-btn" 
              disabled="{{selectedSchedules.length === 0}}"
              bindtap="batchCancel">
        <text class="btn-icon">âŒ</text>
        <text>å–æ¶ˆ</text>
      </button>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="page-content">
    
    <!-- åŠ è½½éª¨æ¶å± -->
    <loading-skeleton wx:if="{{loading && scheduleList.length === 0}}" 
                      type="schedule-list" 
                      count="5" />
    
    <!-- æ—¥ç¨‹åˆ—è¡¨ -->
    <view class="schedule-list" wx:if="{{!loading || scheduleList.length > 0}}">
      <view class="list-container">
        
        <!-- åˆ·æ–°æç¤º -->
        <view class="refresh-tip" wx:if="{{refreshing}}">
          <text class="refresh-icon">ğŸ”„</text>
          <text class="refresh-text">æ­£åœ¨åˆ·æ–°...</text>
        </view>
        
        <!-- æ—¥ç¨‹å¡ç‰‡åˆ—è¡¨ -->
        <view class="schedule-items">
          <schedule-card wx:for="{{filteredScheduleList}}" 
                        wx:key="id"
                        schedule="{{item}}"
                        selectable="{{batchMode}}"
                        selected="{{selectedSchedules.includes(item.id)}}"
                        card-type="default"
                        show-actions="{{!batchMode && permissions.canEdit}}"
                        data-schedule="{{item}}"
                        bind:tap="onScheduleTap"
                        bind:select="onScheduleSelect"
                        bind:action="onScheduleAction"
                        custom-class="schedule-item" />
        </view>
        
        <!-- åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
        <view class="load-more" wx:if="{{loadingMore}}">
          <text class="load-more-icon">â³</text>
          <text class="load-more-text">åŠ è½½æ›´å¤š...</text>
        </view>
        
        <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
        <view class="no-more" wx:if="{{!pagination.hasMore && filteredScheduleList.length > 0}}">
          <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨æ—¥ç¨‹</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€å±•ç¤º -->
    <empty-state wx:if="{{!loading && filteredScheduleList.length === 0}}"
                type="schedule"
                title="æš‚æ— æ—¥ç¨‹å®‰æ’"
                description="{{hasActiveFilters ? 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°æ—¥ç¨‹' : 'è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ—¥ç¨‹å®‰æ’'}}"
                button-text="{{hasActiveFilters ? 'æ¸…é™¤ç­›é€‰' : 'åˆ›å»ºæ—¥ç¨‹'}}"
                bind:action="onEmptyAction" />
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container" wx:if="{{showFab && !batchMode && permissions.canEdit}}">
    <view class="fab-main" bindtap="toggleFab">
      <text class="fab-icon">{{fabExpanded ? 'âœ•' : 'â•'}}</text>
    </view>
    
    <!-- å±•å¼€çš„æ“ä½œæŒ‰é’® -->
    <view class="fab-actions {{fabExpanded ? 'expanded' : ''}}" wx:if="{{fabExpanded}}">
      <view class="fab-action" 
            wx:for="{{fabActions}}" 
            wx:key="key"
            data-action="{{item.key}}"
            bindtap="onFabAction"
            style="background-color: {{item.color}}">
        <text class="fab-action-icon">{{item.icon}}</text>
        <text class="fab-action-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ç»„ä»¶ -->
  <schedule-filter wx:if="{{showFilter}}"
                  visible="{{showFilter}}"
                  filters="{{currentFilters}}"
                  patient-list="{{patientList}}"
                  bind:filter="onFilterChange"
                  bind:close="hideFilter"
                  bind:reset="onFilterReset" />

  <!-- æ›´å¤šæ“ä½œèœå• -->
  <modal wx:if="{{showMoreMenu}}"
         visible="{{showMoreMenu}}"
         title="æ›´å¤šæ“ä½œ"
         bind:close="hideMoreMenu">
    <view slot="content" class="more-menu">
      <view class="menu-item" bindtap="exportSchedule">
        <text class="menu-icon">ğŸ“¤</text>
        <text class="menu-text">å¯¼å‡ºæ—¥ç¨‹</text>
      </view>
      <view class="menu-item" bindtap="syncSchedule">
        <text class="menu-icon">ğŸ”„</text>
        <text class="menu-text">åŒæ­¥æ—¥ç¨‹</text>
      </view>
      <view class="menu-item" bindtap="scheduleSettings">
        <text class="menu-icon">âš™ï¸</text>
        <text class="menu-text">æ—¥ç¨‹è®¾ç½®</text>
      </view>
    </view>
  </modal>

</view>