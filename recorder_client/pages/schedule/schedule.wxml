<view class="schedule-page">
  <view class="page-header">
    <text class="page-title">日程管理</text>
  </view>
  
  <view class="page-content">
    <!-- 统计概览 -->
    <view class="stats-section">
      <text class="stats-title">统计信息</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{statistics.total}}</text>
          <text class="stat-label">总日程</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.today}}</text>
          <text class="stat-label">今日</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.pending}}</text>
          <text class="stat-label">待服务</text>
        </view>
      </view>
    </view>
    
    <!-- 日程列表 -->
    <view class="schedule-list">
      <text class="list-title">日程列表</text>
      
      <!-- 加载状态 -->
      <view wx:if="{{loading}}" class="loading">
        <view class="loading-spinner"></view>
        <text class="loading-text">加载中...</text>
      </view>
      
      <!-- 空状态 -->
      <view wx:elif="{{filteredScheduleList.length === 0 && !loading}}" class="empty-state">
        <text class="empty-icon">📅</text>
        <text class="empty-title">暂无日程安排</text>
        <text class="empty-subtitle">
          {{
            currentFilters.time !== 'all' || currentFilters.status !== 'all' 
            ? '当前筛选条件下没有找到日程' 
            : '您还没有任何日程安排'
          }}
        </text>
        <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all'}}" 
              class="empty-action"
              bindtap="clearFilters">
          <text class="empty-action-text">清除筛选条件</text>
        </view>
      </view>
      
      <!-- 错误状态 -->
      <view wx:elif="{{errorState.hasError}}" class="error-state">
        <text class="error-icon">⚠️</text>
        <text class="error-title">加载失败</text>
        <text class="error-message">{{errorState.errorMessage}}</text>
        <view class="error-actions">
          <view wx:if="{{errorState.canRetry && errorState.retryCount < errorState.maxRetry}}" 
                class="error-btn retry-btn"
                bindtap="retryLastOperation">
            <text class="error-btn-text">重试</text>
          </view>
          <view class="error-btn close-btn" bindtap="clearError">
            <text class="error-btn-text">关闭</text>
          </view>
        </view>
      </view>
      
      <!-- 日程列表内容 -->
      <view wx:else class="schedule-items">
        <view wx:for="{{filteredScheduleList}}" wx:key="id" class="schedule-item">
          <view class="schedule-info">
            <text class="patient-name">{{item.patientName}}</text>
            <text class="schedule-time">{{item.startTime}}</text>
            <text class="schedule-status">{{item.status}}</text>
          </view>
        </view>
        
        <!-- 加载更多 -->
        <view wx:if="{{loadingMore}}" class="loading-more">
          <view class="loading-spinner small"></view>
          <text class="loading-text">加载更多...</text>
        </view>
        
        <!-- 无更多数据 -->
        <view wx:elif="{{!hasMore && filteredScheduleList.length > 0}}" class="no-more">
          <text class="no-more-text">没有更多日程了</text>
        </view>
      </view>
    </view>
    
    <!-- 批量操作面板 -->
    <view wx:if="{{batchMode && selectedSchedules.length > 0}}" class="batch-actions-panel">
      <view class="batch-info">
        <text class="batch-count">已选择 {{selectedSchedules.length}} 项</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn" data-action="reschedule" bindtap="onBatchAction">
          <text class="batch-icon">📅</text>
          <text class="batch-text">批量调整</text>
        </view>
        <view class="batch-btn" data-action="cancel" bindtap="onBatchAction">
          <text class="batch-icon">❌</text>
          <text class="batch-text">批量取消</text>
        </view>
        <view class="batch-btn" data-action="confirm" bindtap="onBatchAction">
          <text class="batch-icon">✅</text>
          <text class="batch-text">批量确认</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 浮动操作按钮 -->
  <view class="fab-container">
    <view class="fab-btn" bindtap="addSchedule">
      <text class="fab-icon">+</text>
    </view>
  </view>
  
  <!-- 筛选器组件 -->
  <schedule-filter 
    visible="{{showFilter}}"
    filters="{{currentFilters}}"
    bind:filter="onFilterChange">
  </schedule-filter>
  
  <!-- 操作弹窗 -->
  <modal
    visible="{{showActionModal}}"
    title="选择操作"
    bind:close="onActionModalClose">
    <view slot="content" class="action-modal-content">
      <view wx:for="{{actionModalActions}}" wx:key="key"
            class="action-modal-item"
            data-action="{{item.key}}"
            bindtap="onScheduleAction">
        <text class="action-modal-icon">{{item.icon}}</text>
        <text class="action-modal-text">{{item.label}}</text>
      </view>
    </view>
  </modal>
  
  <!-- 时间调整弹窗 -->
  <time-adjust-modal
    visible="{{timeAdjustment.modalVisible}}"
    appointmentInfo="{{timeAdjustment.currentAppointment}}"
    isBatch="{{timeAdjustment.isBatch}}"
    batchAppointments="{{timeAdjustment.batchAppointments}}"
    availableSlots="{{timeAdjustment.availableSlots}}"
    bind:success="onTimeAdjustSuccess"
    bind:cancel="onTimeAdjustCancel"
    bind:close="hideTimeAdjustModal">
  </time-adjust-modal>
  
  <!-- 调整历史弹窗 -->
  <modal
    visible="{{timeAdjustment.adjustmentHistory.modalVisible}}"
    title="调整历史"
    type="fullscreen"
    bind:close="onCloseAdjustmentHistory">
    <adjustment-history
      appointmentId="{{timeAdjustment.adjustmentHistory.appointmentId}}"
      recorderId="{{timeAdjustment.adjustmentHistory.recorderId}}"
      bind:reapply="onReapplyAdjustment">
    </adjustment-history>
  </modal>
  
  <!-- 审批管理组件 -->
  <approval-manager
    show="{{approvalManagement.modalVisible}}"
    mode="{{approvalManagement.mode}}"
    request-id="{{approvalManagement.currentRequestId}}"
    user-role="{{approvalManagement.userRole}}"
    bind:view-detail="viewApprovalDetail"
    bind:approval-complete="onApprovalComplete"
    bind:close="closeApprovalManager">
  </approval-manager>
</view>