<view class="schedule-page">
  <!-- å¯¼èˆªæ  -->
  <navigation-bar 
    title="æ—¥ç¨‹ç®¡ç†"
    show-back="{{false}}"
    background="#fff">
    <view slot="right" class="nav-actions">
      <!-- å®¡æ‰¹ç®¡ç†æŒ‰é’® -->
      <view wx:if="{{approvalManagement.hasApprovalPermission}}" 
            class="nav-btn approval-btn" 
            bindtap="openApprovalManager">
        <text class="nav-icon">ğŸ“‹</text>
        <view wx:if="{{approvalManagement.pendingCount > 0}}" class="approval-badge">{{approvalManagement.pendingCount}}</view>
      </view>
      
      <!-- ç­›é€‰æŒ‰é’® -->
      <view class="nav-btn" bindtap="showFilter">
        <text class="nav-icon">ğŸ”</text>
        <text wx:if="{{currentFilters.keyword || currentFilters.status !== 'all'}}" class="filter-dot"></text>
      </view>
    </view>
  </navigation-bar>

  <!-- é¡µé¢å†…å®¹ -->
  <view class="page-content">
    
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="statistics-section">
      <!-- ä¸»è¦ç»Ÿè®¡ -->
      <view class="stats-main-grid">
        <view class="stat-item main-stat" bindtap="onStatItemTap" data-type="total">
          <view class="stat-content">
            <text class="stat-number animated">{{statistics.total}}</text>
            <view class="stat-info">
              <text class="stat-label">æ€»æ—¥ç¨‹</text>
              <view wx:if="{{statistics.trend.percentage > 0}}" class="stat-trend {{statistics.trend.direction}}">
                <text class="trend-icon">{{statistics.trend.direction === 'up' ? 'â†‘' : statistics.trend.direction === 'down' ? 'â†“' : 'â†’'}}</text>
                <text class="trend-text">{{statistics.trend.percentage}}%</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="stat-item" bindtap="onStatItemTap" data-type="today">
          <text class="stat-number today-number animated">{{statistics.today}}</text>
          <text class="stat-label">ä»Šæ—¥</text>
          <view wx:if="{{statistics.today > 0}}" class="stat-badge today-badge">æœ‰å®‰æ’</view>
        </view>
        
        <view class="stat-item" bindtap="onStatItemTap" data-type="pending">
          <text class="stat-number pending-number animated">{{statistics.pending}}</text>
          <text class="stat-label">å¾…æœåŠ¡</text>
          <view wx:if="{{statistics.pending > 0}}" class="stat-badge pending-badge">æ€¥éœ€å¤„ç†</view>
        </view>
        
        <view class="stat-item" bindtap="onStatItemTap" data-type="overdue">
          <text class="stat-number overdue-number animated">{{statistics.overdue}}</text>
          <text class="stat-label">å·²è¿‡æœŸ</text>
          <view wx:if="{{statistics.overdue > 0}}" class="stat-badge overdue-badge">éœ€å…³æ³¨</view>
        </view>
      </view>
      
      <!-- è¯¦ç»†ç»Ÿè®¡ -->
      <view class="stats-detail-section">
        <view class="stats-detail-grid">
          <view class="detail-stat-item">
            <text class="detail-stat-number">{{statistics.completionRate}}%</text>
            <text class="detail-stat-label">å®Œæˆç‡</text>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{statistics.completionRate}}%"></view>
            </view>
          </view>
          
          <view class="detail-stat-item">
            <text class="detail-stat-number">{{statistics.avgDuration}}</text>
            <text class="detail-stat-label">å¹³å‡æ—¶é•¿(åˆ†)</text>
          </view>
          
          <view class="detail-stat-item">
            <text class="detail-stat-number">{{statistics.thisWeek}}</text>
            <text class="detail-stat-label">æœ¬å‘¨æ€»æ•°</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¿«æ·ç­›é€‰ -->
    <view class="quick-filters-section">
      <scroll-view class="quick-filters-scroll" scroll-x="{{true}}" show-scrollbar="{{false}}">
        <view class="quick-filters-list">
          <view wx:for="{{quickFilters}}" wx:key="key"
                class="quick-filter-item {{(item.key === 'today' && currentFilters.time === 'today') || (item.key === 'pending' && currentFilters.status === 'pending') || (item.key === 'urgent' && currentFilters.priority === 'urgent') || (item.key === 'overdue' && currentFilters.time === 'overdue') ? 'active' : ''}}"
                data-key="{{item.key}}"
                bindtap="onQuickFilter">
            <text class="filter-icon">{{item.icon}}</text>
            <text class="filter-label">{{item.label}}</text>
            <view wx:if="{{item.count > 0}}" 
                  class="filter-count {{item.countChanged ? 'animate-in' : ''}}">{{item.count}}</view>
          </view>
          
          <!-- æ¸…é™¤ç­›é€‰æŒ‰é’® -->
          <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all' || currentFilters.priority !== 'all' || currentFilters.keyword}}"
                class="quick-filter-item clear-filter"
                bindtap="clearFilters">
            <text class="filter-icon">âŒ</text>
            <text class="filter-label">æ¸…é™¤</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- æ—¥ç¨‹åˆ—è¡¨ -->
    <view class="schedule-list-section">
      <!-- åˆ—è¡¨å¤´éƒ¨æ“ä½œ -->
      <view class="list-header">
        <view class="list-info">
          <text class="list-count">å…± {{filteredScheduleList.length}} æ¡æ—¥ç¨‹</text>
          <text wx:if="{{currentFilters.sort !== 'time_asc'}}" class="sort-info">
            æŒ‰{{currentFilters.sort === 'time_desc' ? 'æ—¶é—´é™åº' : currentFilters.sort === 'priority_desc' ? 'ä¼˜å…ˆçº§' : 'çŠ¶æ€'}}æ’åº
          </text>
        </view>
        
        <view class="list-actions">
          <view class="action-btn" bindtap="toggleBatchMode">
            <text class="action-icon">{{batchMode ? 'âœ“' : 'â˜‘ï¸'}}</text>
            <text class="action-text">{{batchMode ? 'å®Œæˆ' : 'æ‰¹é‡'}}</text>
          </view>
        </view>
      </view>
      
      <!-- æ‰¹é‡é€‰æ‹©æ“ä½œæ  -->
      <view wx:if="{{batchMode}}" class="batch-selection-bar">
        <view class="selection-info">
          <text class="selected-count">å·²é€‰æ‹© {{selectedSchedules.length}} / {{filteredScheduleList.length}}</text>
        </view>
        <view class="selection-actions">
          <view class="selection-btn" bindtap="selectAll">
            <text class="selection-icon">âœ…</text>
            <text class="selection-text">å…¨é€‰</text>
          </view>
          <view class="selection-btn" bindtap="selectInverse">
            <text class="selection-icon">ğŸ”„</text>
            <text class="selection-text">åé€‰</text>
          </view>
          <view class="selection-btn" bindtap="clearSelection">
            <text class="selection-icon">âŒ</text>
            <text class="selection-text">æ¸…ç©º</text>
          </view>
        </view>
      </view>

      <!-- æ—¥ç¨‹å¡ç‰‡åˆ—è¡¨ -->
      <view class="schedule-cards">
        <!-- éª¨æ¶å±åŠ è½½ -->
        <view wx:if="{{loading && !refreshing}}" class="skeleton-container">
          <view wx:for="{{[1,2,3,4,5]}}" wx:key="*this" class="skeleton-card">
            <view class="skeleton-header">
              <view class="skeleton-avatar"></view>
              <view class="skeleton-info">
                <view class="skeleton-line skeleton-title"></view>
                <view class="skeleton-line skeleton-subtitle"></view>
              </view>
              <view class="skeleton-status"></view>
            </view>
            <view class="skeleton-content">
              <view class="skeleton-line skeleton-text"></view>
              <view class="skeleton-line skeleton-text short"></view>
            </view>
            <view class="skeleton-footer">
              <view class="skeleton-tag"></view>
              <view class="skeleton-tag"></view>
              <view class="skeleton-actions">
                <view class="skeleton-btn"></view>
                <view class="skeleton-btn"></view>
              </view>
            </view>
          </view>
        </view>

        <block wx:elif="{{filteredScheduleList.length > 0}}">
          <schedule-card 
            wx:for="{{filteredScheduleList}}" 
            wx:key="id"
            schedule="{{item}}"
            selectable="{{batchMode}}"
            selected="{{selectedSchedules.indexOf(item.id) > -1}}"
            show-actions="{{!batchMode}}"
            card-type="default"
            bind:tap="onScheduleCardTap"
            bind:longpress="onScheduleCardLongPress"
            bind:action="onScheduleCardAction"
            bind:select="onScheduleSelect">
          </schedule-card>
        </block>

        <!-- ç©ºçŠ¶æ€ -->
        <view wx:elif="{{!loading}}" class="empty-state">
          <text class="empty-icon">ğŸ“…</text>
          <text class="empty-title">æš‚æ— æ—¥ç¨‹å®‰æ’</text>
          <text class="empty-subtitle">
            {{currentFilters.time !== 'all' || currentFilters.status !== 'all' ? 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°æ—¥ç¨‹' : 'æ‚¨è¿˜æ²¡æœ‰ä»»ä½•æ—¥ç¨‹å®‰æ’'}}
          </text>
          <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all'}}" 
                class="empty-action"
                bindtap="clearFilters">
            <text class="empty-action-text">æ¸…é™¤ç­›é€‰æ¡ä»¶</text>
          </view>
        </view>
        
        <!-- é”™è¯¯çŠ¶æ€ -->
        <view wx:if="{{errorState.hasError}}" class="error-state">
          <text class="error-icon">âš ï¸</text>
          <text class="error-title">åŠ è½½å¤±è´¥</text>
          <text class="error-message">{{errorState.errorMessage}}</text>
          <view class="error-actions">
            <view wx:if="{{errorState.canRetry && errorState.retryCount < errorState.maxRetry}}" 
                  class="error-btn retry-btn"
                  bindtap="retryLastOperation">
              <text class="error-btn-text">é‡è¯•</text>
            </view>
            <view class="error-btn close-btn" bindtap="clearError">
              <text class="error-btn-text">å…³é—­</text>
            </view>
          </view>
        </view>

        <!-- åŠ è½½æ›´å¤š -->
        <view wx:if="{{loadingMore}}" class="loading-more">
          <view class="loading-spinner small"></view>
          <text class="loading-text">åŠ è½½æ›´å¤š...</text>
        </view>

        <!-- æ— æ›´å¤šæ•°æ® -->
        <view wx:elif="{{!hasMore && filteredScheduleList.length > 0}}" class="no-more">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ—¥ç¨‹äº†</text>
        </view>
      </view>
    </view>

    <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
    <view wx:if="{{batchMode && selectedSchedules.length > 0}}" class="batch-actions-panel">
      <view class="batch-info">
        <text class="batch-count">å·²é€‰æ‹© {{selectedSchedules.length}} é¡¹</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn" data-action="reschedule" bindtap="onBatchAction">
          <text class="batch-icon">ğŸ“…</text>
          <text class="batch-text">æ‰¹é‡è°ƒæ•´</text>
        </view>
        <view class="batch-btn" data-action="cancel" bindtap="onBatchAction">
          <text class="batch-icon">âŒ</text>
          <text class="batch-text">æ‰¹é‡å–æ¶ˆ</text>
        </view>
        <view class="batch-btn" data-action="confirm" bindtap="onBatchAction">
          <text class="batch-icon">âœ…</text>
          <text class="batch-text">æ‰¹é‡ç¡®è®¤</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ç»„ä»¶ -->
  <schedule-filter 
    visible="{{showFilter}}"
    filters="{{currentFilters}}"
    bind:filter="onFilterChange">
  </schedule-filter>

  <!-- æ“ä½œå¼¹çª— -->
  <modal
    visible="{{showActionModal}}"
    title="é€‰æ‹©æ“ä½œ"
    bind:close="onActionModalClose">
    <view slot="content" class="action-modal-content">
      <view wx:for="{{actionModalActions}}" wx:key="key"
            class="action-modal-item"
            data-action="{{item.key}}"
            bindtap="onScheduleAction">
        <text class="action-modal-icon">{{item.icon}}</text>
        <text class="action-modal-text">{{item.label}}</text>
      </view>
    </view>
  </modal>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-btn" bindtap="addSchedule">
      <text class="fab-icon">+</text>
    </view>
  </view>
  
  <!-- æ—¶é—´è°ƒæ•´å¼¹çª— -->
  <time-adjust-modal
    visible="{{timeAdjustment.modalVisible}}"
    appointmentInfo="{{timeAdjustment.currentAppointment}}"
    isBatch="{{timeAdjustment.isBatch}}"
    batchAppointments="{{timeAdjustment.batchAppointments}}"
    availableSlots="{{timeAdjustment.availableSlots}}"
    bind:success="onTimeAdjustSuccess"
    bind:cancel="onTimeAdjustCancel"
    bind:close="hideTimeAdjustModal">
  </time-adjust-modal>
  
  <!-- è°ƒæ•´å†å²å¼¹çª— -->
  <modal
    visible="{{timeAdjustment.adjustmentHistory.modalVisible}}"
    title="è°ƒæ•´å†å²"
    type="fullscreen"
    bind:close="onCloseAdjustmentHistory">
    <adjustment-history
      appointmentId="{{timeAdjustment.adjustmentHistory.appointmentId}}"
      recorderId="{{timeAdjustment.adjustmentHistory.recorderId}}"
      bind:reapply="onReapplyAdjustment">
    </adjustment-history>
  </modal>
  
  <!-- å®¡æ‰¹ç®¡ç†ç»„ä»¶ -->
  <approval-manager
    show="{{approvalManagement.modalVisible}}"
    mode="{{approvalManagement.mode}}"
    request-id="{{approvalManagement.currentRequestId}}"
    user-role="{{approvalManagement.userRole}}"
    bind:view-detail="viewApprovalDetail"
    bind:approval-complete="onApprovalComplete"
    bind:close="closeApprovalManager">
  </approval-manager>
</view>