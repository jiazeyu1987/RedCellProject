<view class="schedule-page">
  <view class="page-header">
    <text class="page-title">æ—¥ç¨‹ç®¡ç†</text>
  </view>
  
  <view class="page-content">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <view class="stats-section">
      <text class="stats-title">ç»Ÿè®¡ä¿¡æ¯</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-number">{{statistics.total}}</text>
          <text class="stat-label">æ€»æ—¥ç¨‹</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.today}}</text>
          <text class="stat-label">ä»Šæ—¥</text>
        </view>
        <view class="stat-item">
          <text class="stat-number">{{statistics.pending}}</text>
          <text class="stat-label">å¾…æœåŠ¡</text>
        </view>
      </view>
    </view>
    
    <!-- æ—¥ç¨‹åˆ—è¡¨ -->
    <view class="schedule-list">
      <text class="list-title">æ—¥ç¨‹åˆ—è¡¨</text>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{loading}}" class="loading">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view wx:elif="{{filteredScheduleList.length === 0 && !loading}}" class="empty-state">
        <text class="empty-icon">ğŸ“…</text>
        <text class="empty-title">æš‚æ— æ—¥ç¨‹å®‰æ’</text>
        <text class="empty-subtitle">
          {{
            currentFilters.time !== 'all' || currentFilters.status !== 'all' 
            ? 'å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°æ—¥ç¨‹' 
            : 'æ‚¨è¿˜æ²¡æœ‰ä»»ä½•æ—¥ç¨‹å®‰æ’'
          }}
        </text>
        <view wx:if="{{currentFilters.time !== 'all' || currentFilters.status !== 'all'}}" 
              class="empty-action"
              bindtap="clearFilters">
          <text class="empty-action-text">æ¸…é™¤ç­›é€‰æ¡ä»¶</text>
        </view>
      </view>
      
      <!-- é”™è¯¯çŠ¶æ€ -->
      <view wx:elif="{{errorState.hasError}}" class="error-state">
        <text class="error-icon">âš ï¸</text>
        <text class="error-title">åŠ è½½å¤±è´¥</text>
        <text class="error-message">{{errorState.errorMessage}}</text>
        <view class="error-actions">
          <view wx:if="{{errorState.canRetry && errorState.retryCount < errorState.maxRetry}}" 
                class="error-btn retry-btn"
                bindtap="retryLastOperation">
            <text class="error-btn-text">é‡è¯•</text>
          </view>
          <view class="error-btn close-btn" bindtap="clearError">
            <text class="error-btn-text">å…³é—­</text>
          </view>
        </view>
      </view>
      
      <!-- æ—¥ç¨‹åˆ—è¡¨å†…å®¹ -->
      <view wx:else class="schedule-items">
        <view wx:for="{{filteredScheduleList}}" wx:key="id" class="schedule-item">
          <view class="schedule-info">
            <text class="patient-name">{{item.patientName}}</text>
            <text class="schedule-time">{{item.startTime}}</text>
            <text class="schedule-status">{{item.status}}</text>
          </view>
        </view>
        
        <!-- åŠ è½½æ›´å¤š -->
        <view wx:if="{{loadingMore}}" class="loading-more">
          <view class="loading-spinner small"></view>
          <text class="loading-text">åŠ è½½æ›´å¤š...</text>
        </view>
        
        <!-- æ— æ›´å¤šæ•°æ® -->
        <view wx:elif="{{!hasMore && filteredScheduleList.length > 0}}" class="no-more">
          <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ—¥ç¨‹äº†</text>
        </view>
      </view>
    </view>
    
    <!-- æ‰¹é‡æ“ä½œé¢æ¿ -->
    <view wx:if="{{batchMode && selectedSchedules.length > 0}}" class="batch-actions-panel">
      <view class="batch-info">
        <text class="batch-count">å·²é€‰æ‹© {{selectedSchedules.length}} é¡¹</text>
      </view>
      <view class="batch-actions">
        <view class="batch-btn" data-action="reschedule" bindtap="onBatchAction">
          <text class="batch-icon">ğŸ“…</text>
          <text class="batch-text">æ‰¹é‡è°ƒæ•´</text>
        </view>
        <view class="batch-btn" data-action="cancel" bindtap="onBatchAction">
          <text class="batch-icon">âŒ</text>
          <text class="batch-text">æ‰¹é‡å–æ¶ˆ</text>
        </view>
        <view class="batch-btn" data-action="confirm" bindtap="onBatchAction">
          <text class="batch-icon">âœ…</text>
          <text class="batch-text">æ‰¹é‡ç¡®è®¤</text>
        </view>
      </view>
    </view>
  </view>
  
  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="fab-container">
    <view class="fab-btn" bindtap="addSchedule">
      <text class="fab-icon">+</text>
    </view>
  </view>
  
  <!-- ç­›é€‰å™¨ç»„ä»¶ -->
  <schedule-filter 
    visible="{{showFilter}}"
    filters="{{currentFilters}}"
    bind:filter="onFilterChange">
  </schedule-filter>
  
  <!-- æ“ä½œå¼¹çª— -->
  <modal
    visible="{{showActionModal}}"
    title="é€‰æ‹©æ“ä½œ"
    bind:close="onActionModalClose">
    <view slot="content" class="action-modal-content">
      <view wx:for="{{actionModalActions}}" wx:key="key"
            class="action-modal-item"
            data-action="{{item.key}}"
            bindtap="onScheduleAction">
        <text class="action-modal-icon">{{item.icon}}</text>
        <text class="action-modal-text">{{item.label}}</text>
      </view>
    </view>
  </modal>
  
  <!-- æ—¶é—´è°ƒæ•´å¼¹çª— -->
  <time-adjust-modal
    visible="{{timeAdjustment.modalVisible}}"
    appointmentInfo="{{timeAdjustment.currentAppointment}}"
    isBatch="{{timeAdjustment.isBatch}}"
    batchAppointments="{{timeAdjustment.batchAppointments}}"
    availableSlots="{{timeAdjustment.availableSlots}}"
    bind:success="onTimeAdjustSuccess"
    bind:cancel="onTimeAdjustCancel"
    bind:close="hideTimeAdjustModal">
  </time-adjust-modal>
  
  <!-- è°ƒæ•´å†å²å¼¹çª— -->
  <modal
    visible="{{timeAdjustment.adjustmentHistory.modalVisible}}"
    title="è°ƒæ•´å†å²"
    type="fullscreen"
    bind:close="onCloseAdjustmentHistory">
    <adjustment-history
      appointmentId="{{timeAdjustment.adjustmentHistory.appointmentId}}"
      recorderId="{{timeAdjustment.adjustmentHistory.recorderId}}"
      bind:reapply="onReapplyAdjustment">
    </adjustment-history>
  </modal>
  
  <!-- å®¡æ‰¹ç®¡ç†ç»„ä»¶ -->
  <approval-manager
    show="{{approvalManagement.modalVisible}}"
    mode="{{approvalManagement.mode}}"
    request-id="{{approvalManagement.currentRequestId}}"
    user-role="{{approvalManagement.userRole}}"
    bind:view-detail="viewApprovalDetail"
    bind:approval-complete="onApprovalComplete"
    bind:close="closeApprovalManager">
  </approval-manager>
</view>