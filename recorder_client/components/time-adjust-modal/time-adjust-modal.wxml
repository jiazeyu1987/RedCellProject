<!--components/time-adjust-modal/time-adjust-modal.wxml-->
<modal
  visible="{{visible}}"
  title="{{isBatch ? 'æ‰¹é‡è°ƒæ•´æ—¶é—´' : 'è°ƒæ•´é¢„çº¦æ—¶é—´'}}"
  type="fullscreen"
  showFooter="{{false}}"
  maskClosable="{{false}}"
  bind:close="closeModal">
  
  <!-- å¼¹çª—å†…å®¹ -->
  <view class="time-adjust-container">
    
    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <view class="step-indicator">
      <view class="step-item {{modalState.step >= 1 ? 'active' : ''}}" data-step="1">
        <view class="step-number">1</view>
        <view class="step-title">é€‰æ‹©æ—¶é—´</view>
      </view>
      <view class="step-line {{modalState.step >= 2 ? 'active' : ''}}"></view>
      <view class="step-item {{modalState.step >= 2 ? 'active' : ''}}" data-step="2" wx:if="{{conflictResult.hasConflict}}">
        <view class="step-number">2</view>
        <view class="step-title">è§£å†³å†²çª</view>
      </view>
      <view class="step-line {{modalState.step >= 3 ? 'active' : ''}}" wx:if="{{conflictResult.hasConflict}}"></view>
      <view class="step-item {{modalState.step >= 3 || (modalState.step >= 2 && !conflictResult.hasConflict) ? 'active' : ''}}" 
            data-step="{{conflictResult.hasConflict ? 3 : 2}}">
        <view class="step-number">{{conflictResult.hasConflict ? 3 : 2}}</view>
        <view class="step-title">ç¡®è®¤è°ƒæ•´</view>
      </view>
    </view>

    <!-- ç¬¬ä¸€æ­¥ï¼šæ—¶é—´é€‰æ‹© -->
    <view class="step-content" wx:if="{{modalState.step === 1}}">
      
      <!-- å½“å‰é¢„çº¦ä¿¡æ¯ -->
      <view class="current-appointment">
        <view class="section-title">
          <text class="title-icon">ğŸ“…</text>
          <text class="title-text">å½“å‰é¢„çº¦</text>
        </view>
        <view class="appointment-card">
          <view class="appointment-time">
            <text class="date">{{originalTime.date}}</text>
            <text class="time">{{originalTime.startTime}} - {{originalTime.endTime}}</text>
          </view>
          <view class="appointment-info" wx:if="{{!isBatch}}">
            <text class="patient">æ‚£è€…ï¼š{{appointmentInfo.patientName}}</text>
            <text class="service">æœåŠ¡ï¼š{{appointmentInfo.serviceType}}</text>
          </view>
          <view class="batch-info" wx:else>
            <text class="count">å…± {{batchAppointments.length}} ä¸ªé¢„çº¦</text>
          </view>
        </view>
      </view>

      <!-- æ–°æ—¶é—´é€‰æ‹© -->
      <view class="time-selection">
        <view class="section-title">
          <text class="title-icon">ğŸ•’</text>
          <text class="title-text">é€‰æ‹©æ–°æ—¶é—´</text>
        </view>
        
        <!-- æ—¥æœŸé€‰æ‹© -->
        <form-item 
          label="è°ƒæ•´æ—¥æœŸ"
          required="{{true}}"
          error="{{!validation.dateValid}}"
          errorText="è¯·é€‰æ‹©è°ƒæ•´æ—¥æœŸ">
          <picker 
            mode="date"
            value="{{newTime.date}}"
            start="{{datePickerConfig.minDate}}"
            end="{{datePickerConfig.maxDate}}"
            bind:change="onDateChange">
            <view class="picker-display {{newTime.date ? '' : 'placeholder'}}">
              {{newTime.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}
            </view>
          </picker>
        </form-item>

        <!-- å¼€å§‹æ—¶é—´é€‰æ‹© -->
        <form-item 
          label="å¼€å§‹æ—¶é—´"
          required="{{true}}"
          error="{{!validation.timeValid}}"
          errorText="è¯·é€‰æ‹©æœåŠ¡æ—¶é—´">
          <picker 
            mode="time"
            value="{{newTime.startTime}}"
            bind:change="onStartTimeChange">
            <view class="picker-display {{newTime.startTime ? '' : 'placeholder'}}">
              {{newTime.startTime || 'è¯·é€‰æ‹©å¼€å§‹æ—¶é—´'}}
            </view>
          </picker>
        </form-item>

        <!-- ç»“æŸæ—¶é—´é€‰æ‹© -->
        <form-item 
          label="ç»“æŸæ—¶é—´"
          required="{{true}}"
          error="{{!validation.timeValid}}"
          errorText="è¯·é€‰æ‹©ç»“æŸæ—¶é—´">
          <picker 
            mode="time"
            value="{{newTime.endTime}}"
            bind:change="onEndTimeChange">
            <view class="picker-display {{newTime.endTime ? '' : 'placeholder'}}">
              {{newTime.endTime || 'è¯·é€‰æ‹©ç»“æŸæ—¶é—´'}}
            </view>
          </picker>
        </form-item>
      </view>

      <!-- æ™ºèƒ½æ¨è -->
      <view class="smart-recommend" wx:if="{{showSmartRecommend && recommendedSlots.length > 0}}">
        <view class="section-title">
          <text class="title-icon">ğŸ¤–</text>
          <text class="title-text">æ™ºèƒ½æ¨è</text>
        </view>
        
        <view class="recommend-list">
          <view 
            class="recommend-item {{selectedRecommend === index ? 'selected' : ''}}"
            wx:for="{{recommendedSlots}}"
            wx:key="index"
            data-index="{{index}}"
            bind:tap="onRecommendSelect">
            <view class="recommend-time">
              <text class="date">{{item.date}}</text>
              <text class="time">{{item.startTime}} - {{item.endTime}}</text>
            </view>
            <view class="recommend-info">
              <view class="score">æ¨èåº¦: {{item.score}}%</view>
              <view class="reason">{{item.reason}}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- è°ƒæ•´åŸå› é€‰æ‹© -->
      <view class="reason-selection">
        <view class="section-title">
          <text class="title-icon">ğŸ“</text>
          <text class="title-text">è°ƒæ•´åŸå› </text>
        </view>
        
        <view class="reason-options">
          <view 
            class="reason-option {{adjustReason === item ? 'selected' : ''}}"
            wx:for="{{reasonOptions}}"
            wx:key="*this"
            data-reason="{{item}}"
            bind:tap="onReasonSelect">
            {{item}}
          </view>
        </view>
        
        <!-- è‡ªå®šä¹‰åŸå› è¾“å…¥ -->
        <form-item 
          wx:if="{{modalState.showReasonInput}}"
          label="è¯¦ç»†åŸå› "
          required="{{true}}">
          <textarea 
            placeholder="è¯·è¯¦ç»†è¯´æ˜è°ƒæ•´åŸå› ..."
            value="{{adjustReason}}"
            maxlength="200"
            bind:input="onReasonInput"
            class="reason-input">
          </textarea>
        </form-item>
      </view>
    </view>

    <!-- ç¬¬äºŒæ­¥ï¼šå†²çªè§£å†³ -->
    <view class="step-content" wx:if="{{modalState.step === 2 && conflictResult.hasConflict}}">
      <view class="conflict-warning">
        <view class="warning-header">
          <text class="warning-icon">âš ï¸</text>
          <text class="warning-title">æ—¶é—´å†²çªæé†’</text>
        </view>
        <text class="warning-message">æ‚¨é€‰æ‹©çš„æ—¶é—´ä¸ä»¥ä¸‹é¢„çº¦å­˜åœ¨å†²çªï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´æˆ–å¤„ç†å†²çªã€‚</text>
      </view>

      <!-- å†²çªé¢„çº¦åˆ—è¡¨ -->
      <view class="conflict-list">
        <view class="conflict-item" wx:for="{{conflictResult.conflictAppointments}}" wx:key="id">
          <view class="conflict-time">{{item.date}} {{item.startTime}}-{{item.endTime}}</view>
          <view class="conflict-patient">æ‚£è€…ï¼š{{item.patientName}}</view>
          <view class="conflict-service">æœåŠ¡ï¼š{{item.serviceType}}</view>
        </view>
      </view>

      <!-- å»ºè®®è§£å†³æ–¹æ¡ˆ -->
      <view class="suggestions" wx:if="{{conflictResult.suggestions.length > 0}}">
        <view class="section-title">
          <text class="title-icon">ğŸ’¡</text>
          <text class="title-text">å»ºè®®è§£å†³æ–¹æ¡ˆ</text>
        </view>
        <view class="suggestion-list">
          <view class="suggestion-item" wx:for="{{conflictResult.suggestions}}" wx:key="index">
            <view class="suggestion-title">{{item.title}}</view>
            <view class="suggestion-desc">{{item.description}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤è°ƒæ•´ -->
    <view class="step-content" wx:if="{{modalState.step === 3 || (modalState.step === 2 && !conflictResult.hasConflict)}}">
      <view class="confirm-info">
        <view class="section-title">
          <text class="title-icon">âœ…</text>
          <text class="title-text">ç¡®è®¤è°ƒæ•´ä¿¡æ¯</text>
        </view>
        
        <!-- è°ƒæ•´å¯¹æ¯” -->
        <view class="time-comparison">
          <view class="comparison-row">
            <view class="label">åŸæ—¶é—´ï¼š</view>
            <view class="original-time">
              {{originalTime.date}} {{originalTime.startTime}}-{{originalTime.endTime}}
            </view>
          </view>
          <view class="arrow">â¬‡ï¸</view>
          <view class="comparison-row">
            <view class="label">æ–°æ—¶é—´ï¼š</view>
            <view class="new-time">
              {{newTime.date}} {{newTime.startTime}}-{{newTime.endTime}}
            </view>
          </view>
        </view>

        <!-- è°ƒæ•´åŸå›  -->
        <view class="reason-display">
          <view class="label">è°ƒæ•´åŸå› ï¼š</view>
          <view class="reason-text">{{adjustReason}}</view>
        </view>

        <!-- å½±å“æé†’ -->
        <view class="impact-notice">
          <text class="notice-icon">â„¹ï¸</text>
          <text class="notice-text">è°ƒæ•´åå°†è‡ªåŠ¨é€šçŸ¥ç›¸å…³äººå‘˜ï¼Œè¯·ç¡®è®¤ä¿¡æ¯æ— è¯¯åæäº¤ã€‚</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="modal-footer">
      <!-- å–æ¶ˆæŒ‰é’® -->
      <button 
        class="cancel-btn" 
        bind:tap="onCancel"
        disabled="{{modalState.submitting}}">
        å–æ¶ˆ
      </button>
      
      <!-- ä¸Šä¸€æ­¥æŒ‰é’® -->
      <button 
        class="prev-btn" 
        bind:tap="onPrevStep"
        wx:if="{{modalState.step > 1}}"
        disabled="{{modalState.submitting}}">
        ä¸Šä¸€æ­¥
      </button>
      
      <!-- ä¸‹ä¸€æ­¥æŒ‰é’® -->
      <button 
        class="next-btn" 
        bind:tap="onNextStep"
        wx:if="{{modalState.step < 3 && (modalState.step !== 2 || conflictResult.hasConflict)}}"
        disabled="{{modalState.loading}}">
        ä¸‹ä¸€æ­¥
      </button>
      
      <!-- ç¡®è®¤è°ƒæ•´æŒ‰é’® -->
      <button 
        class="confirm-btn" 
        bind:tap="onSubmit"
        wx:if="{{modalState.step === 3 || (modalState.step === 2 && !conflictResult.hasConflict)}}"
        loading="{{modalState.submitting}}"
        disabled="{{modalState.submitting}}">
        {{modalState.submitting ? 'è°ƒæ•´ä¸­...' : 'ç¡®è®¤è°ƒæ•´'}}
      </button>
    </view>
  </view>
</modal>