<!--components/adjustment-history/adjustment-history.wxml-->
<view class="adjustment-history-container">
  
  <!-- å¤´éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="statistics-header">
    <view class="stat-item">
      <text class="stat-number">{{statistics.totalAdjustments}}</text>
      <text class="stat-label">æ€»è°ƒæ•´æ¬¡æ•°</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.approvedCount}}</text>
      <text class="stat-label">å·²æ‰¹å‡†</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.pendingCount}}</text>
      <text class="stat-label">å¾…ç¡®è®¤</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{statistics.rejectedCount}}</text>
      <text class="stat-label">å·²æ‹’ç»</text>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-bar" wx:if="{{showFilter}}">
    <view class="filter-item" bind:tap="showFilterPanel">
      <text class="filter-icon">ğŸ”</text>
      <text class="filter-text">ç­›é€‰</text>
    </view>
    <view class="display-mode-toggle">
      <view 
        class="mode-item {{displayMode === 'list' ? 'active' : ''}}"
        data-mode="list"
        bind:tap="onDisplayModeChange">
        åˆ—è¡¨
      </view>
      <view 
        class="mode-item {{displayMode === 'timeline' ? 'active' : ''}}"
        data-mode="timeline"
        bind:tap="onDisplayModeChange">
        æ—¶é—´è½´
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <scroll-view 
    class="history-list"
    scroll-y="{{true}}"
    refresher-enabled="{{true}}"
    refresher-triggered="{{loading}}"
    bind:refresherrefresh="onPullDownRefresh"
    bind:scrolltolower="onLoadMore">
    
    <!-- åˆ—è¡¨æ¨¡å¼ -->
    <view wx:if="{{displayMode === 'list'}}">
      <view 
        class="history-item"
        wx:for="{{historyList}}"
        wx:key="id"
        data-record="{{item}}"
        bind:tap="onViewDetail">
        
        <view class="item-header">
          <view class="adjustment-info">
            <text class="patient-name">{{item.patientName}}</text>
            <view class="status-tag status-{{item.status}}">
              {{item.status === 'approved' ? 'å·²æ‰¹å‡†' : 
                item.status === 'rejected' ? 'å·²æ‹’ç»' : 
                item.status === 'pending' ? 'å¾…ç¡®è®¤' : 'å·²å®Œæˆ'}}
            </view>
          </view>
          <text class="adjust-time">{{item.adjustTime}}</text>
        </view>
        
        <view class="time-comparison">
          <view class="time-row">
            <text class="time-label">åŸæ—¶é—´ï¼š</text>
            <text class="original-time">{{item.originalTime}}</text>
          </view>
          <view class="time-row">
            <text class="time-label">æ–°æ—¶é—´ï¼š</text>
            <text class="new-time">{{item.newTime}}</text>
          </view>
        </view>
        
        <view class="adjustment-reason">
          <text class="reason-label">è°ƒæ•´åŸå› ï¼š</text>
          <text class="reason-text">{{item.reason}}</text>
        </view>
      </view>
    </view>

    <!-- æ—¶é—´è½´æ¨¡å¼ -->
    <view class="timeline-container" wx:if="{{displayMode === 'timeline'}}">
      <view 
        class="timeline-item"
        wx:for="{{historyList}}"
        wx:key="id"
        data-record="{{item}}"
        bind:tap="onViewDetail">
        
        <view class="timeline-dot status-{{item.status}}"></view>
        <view class="timeline-content">
          <view class="timeline-header">
            <text class="timeline-title">{{item.patientName}} - æ—¶é—´è°ƒæ•´</text>
            <text class="timeline-time">{{item.adjustTime}}</text>
          </view>
          <view class="timeline-details">
            <text class="timeline-change">{{item.originalTime}} â†’ {{item.newTime}}</text>
            <text class="timeline-reason">åŸå› ï¼š{{item.reason}}</text>
          </view>
          <view class="timeline-status status-{{item.status}}">
            {{item.status === 'approved' ? 'å·²æ‰¹å‡†' : 
              item.status === 'rejected' ? 'å·²æ‹’ç»' : 
              item.status === 'pending' ? 'å¾…ç¡®è®¤' : 'å·²å®Œæˆ'}}
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && historyList.length > 0}}">
      <text wx:if="{{loading}}">åŠ è½½ä¸­...</text>
      <text wx:else>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!loading && historyList.length === 0}}">
      <image class="empty-icon" src="/images/empty-history.png" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— è°ƒæ•´å†å²</text>
    </view>
  </scroll-view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel {{filterPanelVisible ? 'visible' : ''}}" wx:if="{{showFilter}}">
    <view class="panel-header">
      <text class="panel-title">ç­›é€‰æ¡ä»¶</text>
      <view class="panel-close" bind:tap="closeFilterPanel">âœ•</view>
    </view>
    
    <view class="filter-content">
      <!-- æ—¶é—´èŒƒå›´ç­›é€‰ -->
      <view class="filter-section">
        <text class="section-title">æ—¶é—´èŒƒå›´</text>
        <picker 
          mode="date"
          value="{{filters.startDate}}"
          bind:change="onStartDateChange">
          <view class="date-picker">
            <text>{{filters.startDate || 'å¼€å§‹æ—¥æœŸ'}}</text>
          </view>
        </picker>
        <picker 
          mode="date"
          value="{{filters.endDate}}"
          bind:change="onEndDateChange">
          <view class="date-picker">
            <text>{{filters.endDate || 'ç»“æŸæ—¥æœŸ'}}</text>
          </view>
        </picker>
      </view>
      
      <!-- çŠ¶æ€ç­›é€‰ -->
      <view class="filter-section">
        <text class="section-title">è°ƒæ•´çŠ¶æ€</text>
        <view class="status-options">
          <view 
            class="status-option {{filters.status === item.key ? 'selected' : ''}}"
            wx:for="{{filterOptions.statuses}}"
            wx:key="key"
            data-status="{{item.key}}"
            bind:tap="onStatusFilterChange">
            {{item.label}}
          </view>
        </view>
      </view>
      
      <!-- åŸå› ç­›é€‰ -->
      <view class="filter-section">
        <text class="section-title">è°ƒæ•´åŸå› </text>
        <view class="reason-options">
          <view 
            class="reason-option {{filters.reason === item ? 'selected' : ''}}"
            wx:for="{{filterOptions.reasons}}"
            wx:key="*this"
            data-reason="{{item}}"
            bind:tap="onReasonFilterChange">
            {{item}}
          </view>
        </view>
      </view>
    </view>
    
    <view class="panel-footer">
      <button class="reset-btn" bind:tap="onResetFilter">é‡ç½®</button>
      <button class="apply-btn" bind:tap="onApplyFilter">åº”ç”¨</button>
    </view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <modal
    visible="{{detailModalVisible}}"
    title="è°ƒæ•´è¯¦æƒ…"
    type="fullscreen"
    bind:close="closeDetailModal">
    
    <view class="detail-content" wx:if="{{selectedRecord}}">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="section-header">
          <text class="section-icon">ğŸ“‹</text>
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>
        </view>
        <view class="info-row">
          <text class="info-label">æ‚£è€…å§“åï¼š</text>
          <text class="info-value">{{selectedRecord.patientName}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">é¢„çº¦IDï¼š</text>
          <text class="info-value">{{selectedRecord.appointmentId}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">è°ƒæ•´æ—¶é—´ï¼š</text>
          <text class="info-value">{{selectedRecord.adjustTime}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">å½“å‰çŠ¶æ€ï¼š</text>
          <view class="status-tag status-{{selectedRecord.status}}">
            {{selectedRecord.status === 'approved' ? 'å·²æ‰¹å‡†' : 
              selectedRecord.status === 'rejected' ? 'å·²æ‹’ç»' : 
              selectedRecord.status === 'pending' ? 'å¾…ç¡®è®¤' : 'å·²å®Œæˆ'}}
          </view>
        </view>
      </view>
      
      <!-- æ—¶é—´å˜æ›´ä¿¡æ¯ -->
      <view class="detail-section">
        <view class="section-header">
          <text class="section-icon">ğŸ•’</text>
          <text class="section-title">æ—¶é—´å˜æ›´</text>
        </view>
        <view class="time-change-display">
          <view class="change-row">
            <text class="change-label">åŸæ—¶é—´ï¼š</text>
            <text class="original-time-detail">{{selectedRecord.originalTime}}</text>
          </view>
          <view class="change-arrow">â¬‡ï¸</view>
          <view class="change-row">
            <text class="change-label">æ–°æ—¶é—´ï¼š</text>
            <text class="new-time-detail">{{selectedRecord.newTime}}</text>
          </view>
        </view>
      </view>
      
      <!-- è°ƒæ•´åŸå›  -->
      <view class="detail-section">
        <view class="section-header">
          <text class="section-icon">ğŸ“</text>
          <text class="section-title">è°ƒæ•´åŸå› </text>
        </view>
        <text class="reason-detail">{{selectedRecord.reason}}</text>
      </view>
      
      <!-- æ“ä½œè®°å½• -->
      <view class="detail-section" wx:if="{{selectedRecord.operations}}">
        <view class="section-header">
          <text class="section-icon">ğŸ“Š</text>
          <text class="section-title">æ“ä½œè®°å½•</text>
        </view>
        <view class="operation-list">
          <view 
            class="operation-item"
            wx:for="{{selectedRecord.operations}}"
            wx:key="id">
            <view class="operation-time">{{item.time}}</view>
            <view class="operation-desc">{{item.description}}</view>
            <view class="operation-user">æ“ä½œäººï¼š{{item.operator}}</view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="detail-footer" slot="footer">
      <button class="close-btn" bind:tap="closeDetailModal">å…³é—­</button>
      <button 
        class="reapply-btn" 
        wx:if="{{selectedRecord.status === 'rejected'}}"
        bind:tap="onReapplyAdjustment">
        é‡æ–°ç”³è¯·
      </button>
    </view>
  </modal>
</view>