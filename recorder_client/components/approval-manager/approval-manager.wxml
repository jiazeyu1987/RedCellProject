<!--å®¡æ‰¹ç®¡ç†ç»„ä»¶-->
<view class="approval-manager" wx:if="{{show}}">
  <!-- å¤´éƒ¨ -->
  <view class="approval-header">
    <view class="header-title">
      <text class="title">{{mode === 'list' ? 'å®¡æ‰¹ç®¡ç†' : 'å®¡æ‰¹è¯¦æƒ…'}}</text>
      <view class="close-btn" bind:tap="close">
        <text class="icon">âœ•</text>
      </view>
    </view>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ï¼ˆåˆ—è¡¨æ¨¡å¼ï¼‰ -->
    <view class="statistics" wx:if="{{mode === 'list'}}">
      <view class="stat-item">
        <text class="stat-number">{{statistics.total}}</text>
        <text class="stat-label">æ€»è®¡</text>
      </view>
      <view class="stat-item pending">
        <text class="stat-number">{{statistics.pending}}</text>
        <text class="stat-label">å¾…å®¡æ‰¹</text>
      </view>
      <view class="stat-item urgent">
        <text class="stat-number">{{statistics.urgent}}</text>
        <text class="stat-label">ç´§æ€¥</text>
      </view>
      <view class="stat-item overdue">
        <text class="stat-number">{{statistics.overdue}}</text>
        <text class="stat-label">è¿‡æœŸ</text>
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨æ¨¡å¼ -->
  <view class="approval-list" wx:if="{{mode === 'list'}}">
    <!-- ç­›é€‰å’Œæ’åº -->
    <view class="filter-bar">
      <view class="filter-tabs">
        <view class="tab-item {{filterStatus === 'pending_approval' ? 'active' : ''}}" 
              data-status="pending_approval" bind:tap="switchFilterStatus">
          å¾…å®¡æ‰¹
        </view>
        <view class="tab-item {{filterStatus === 'approved' ? 'active' : ''}}" 
              data-status="approved" bind:tap="switchFilterStatus">
          å·²æ‰¹å‡†
        </view>
        <view class="tab-item {{filterStatus === 'rejected' ? 'active' : ''}}" 
              data-status="rejected" bind:tap="switchFilterStatus">
          å·²æ‹’ç»
        </view>
      </view>
      
      <view class="sort-options">
        <text class="sort-label">æ’åº:</text>
        <view class="sort-item {{sortBy === 'priority' ? 'active' : ''}}" 
              data-sort-by="priority" bind:tap="switchSortBy">
          ä¼˜å…ˆçº§
        </view>
        <view class="sort-item {{sortBy === 'time' ? 'active' : ''}}" 
              data-sort-by="time" bind:tap="switchSortBy">
          æ—¶é—´
        </view>
      </view>
    </view>

    <!-- ä»»åŠ¡åˆ—è¡¨ -->
    <scroll-view class="task-list" scroll-y>
      <view class="task-item" wx:for="{{approvalTasks}}" wx:key="id" 
            data-request-id="{{item.id}}" bind:tap="viewTaskDetail">
        <custom-card>
          <view class="task-content">
            <!-- å¤´éƒ¨ä¿¡æ¯ -->
            <view class="task-header">
              <view class="task-info">
                <text class="applicant-name">{{item.applicantName}}</text>
                <status-tag 
                  type="{{item.adjustType}}" 
                  size="small" 
                  text="{{item.adjustType === 'normal' ? 'æ™®é€š' : (item.adjustType === 'advanced' ? 'é«˜çº§' : 'ç´§æ€¥')}}"
                ></status-tag>
              </view>
              
              <view class="task-priority" style="color: {{getPriorityColor(item.priority)}}">
                <text class="priority-score">{{item.priority}}</text>
                <text class="priority-label">ä¼˜å…ˆçº§</text>
              </view>
            </view>

            <!-- è°ƒæ•´ä¿¡æ¯ -->
            <view class="adjust-info">
              <view class="time-change">
                <text class="original-time">åŸæ—¶é—´: {{item.originalTime}}</text>
                <text class="arrow">â†’</text>
                <text class="new-time">æ–°æ—¶é—´: {{item.newTime}}</text>
              </view>
              <text class="reason">åŸå› : {{item.reason}}</text>
            </view>

            <!-- è¿›åº¦ä¿¡æ¯ -->
            <view class="progress-info">
              <view class="progress-bar">
                <view class="progress-fill" 
                      style="width: {{(item.currentStep / item.totalSteps) * 100}}%"></view>
              </view>
              <text class="progress-text">{{item.currentStep}}/{{item.totalSteps}}</text>
            </view>

            <!-- åº•éƒ¨æ“ä½œ -->
            <view class="task-actions">
              <text class="created-time">{{formatTime(item.createdAt)}}</text>
              
              <view class="action-buttons">
                <custom-button 
                  type="primary" 
                  size="small" 
                  text="å¿«é€Ÿæ‰¹å‡†"
                  data-request-id="{{item.id}}"
                  bind:tap="quickApprove"
                  wx:if="{{item.urgentLevel !== 'urgent'}}"
                ></custom-button>
                
                <custom-button 
                  type="default" 
                  size="small" 
                  text="æŸ¥çœ‹è¯¦æƒ…"
                  data-request-id="{{item.id}}"
                  bind:tap="viewTaskDetail"
                ></custom-button>
              </view>
            </view>
          </view>
        </custom-card>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!loading && approvalTasks.length === 0}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">æš‚æ— å®¡æ‰¹ä»»åŠ¡</text>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-state" wx:if="{{loading}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
    </scroll-view>
  </view>

  <!-- è¯¦æƒ…æ¨¡å¼ -->
  <view class="approval-detail" wx:if="{{mode === 'detail' && currentTask}}">
    <!-- ä»»åŠ¡ä¿¡æ¯ -->
    <view class="detail-section">
      <view class="section-title">ç”³è¯·ä¿¡æ¯</view>
      <custom-card>
        <view class="detail-content">
          <view class="detail-row">
            <text class="label">ç”³è¯·äºº:</text>
            <text class="value">{{currentTask.applicantName}}</text>
          </view>
          <view class="detail-row">
            <text class="label">è°ƒæ•´ç±»å‹:</text>
            <status-tag 
              type="{{currentTask.adjustType}}" 
              text="{{currentTask.adjustType === 'normal' ? 'æ™®é€šè°ƒæ•´' : (currentTask.adjustType === 'advanced' ? 'é«˜çº§è°ƒæ•´' : 'ç´§æ€¥è°ƒæ•´')}}"
            ></status-tag>
          </view>
          <view class="detail-row">
            <text class="label">åŸé¢„çº¦æ—¶é—´:</text>
            <text class="value">{{currentTask.originalTime}}</text>
          </view>
          <view class="detail-row">
            <text class="label">æ–°é¢„çº¦æ—¶é—´:</text>
            <text class="value">{{currentTask.newTime}}</text>
          </view>
          <view class="detail-row">
            <text class="label">è°ƒæ•´åŸå› :</text>
            <text class="value reason-text">{{currentTask.reason}}</text>
          </view>
          <view class="detail-row">
            <text class="label">å½±å“è¯„åˆ†:</text>
            <text class="value impact-score" style="color: {{currentTask.impactScore > 60 ? '#f5222d' : '#52c41a'}}">{{currentTask.impactScore}}åˆ†</text>
          </view>
        </view>
      </custom-card>
    </view>

    <!-- å®¡æ‰¹æµç¨‹ -->
    <view class="detail-section">
      <view class="section-title">å®¡æ‰¹æµç¨‹</view>
      <custom-card>
        <view class="workflow-steps">
          <view class="step-item {{index < currentTask.currentStep ? 'completed' : (index === currentTask.currentStep - 1 ? 'current' : 'pending')}}" 
                wx:for="{{currentTask.workflow.steps}}" wx:key="step">
            <view class="step-indicator">
              <text class="step-number">{{item.step}}</text>
            </view>
            <view class="step-content">
              <text class="step-name">{{item.name}}</text>
              <text class="step-role">{{item.role}}</text>
            </view>
          </view>
        </view>
      </custom-card>
    </view>

    <!-- å®¡æ‰¹å†å² -->
    <view class="detail-section" wx:if="{{currentTask.approvalHistory.length > 0}}">
      <view class="section-title">å®¡æ‰¹å†å²</view>
      <custom-card>
        <view class="history-list">
          <view class="history-item" wx:for="{{currentTask.approvalHistory}}" wx:key="timestamp">
            <view class="history-header">
              <text class="approver-name">{{item.approverName}}</text>
              <status-tag 
                type="{{item.decision}}" 
                text="{{item.decision === 'approve' ? 'æ‰¹å‡†' : (item.decision === 'reject' ? 'æ‹’ç»' : 'è¦æ±‚ä¿®æ”¹')}}"
                size="small"
              ></status-tag>
            </view>
            <text class="history-comment" wx:if="{{item.comment}}">{{item.comment}}</text>
            <text class="history-time">{{formatTime(item.timestamp)}}</text>
          </view>
        </view>
      </custom-card>
    </view>

    <!-- å®¡æ‰¹æ“ä½œ -->
    <view class="detail-section" wx:if="{{currentTask.status === 'pending_approval'}}">
      <view class="section-title">å®¡æ‰¹æ“ä½œ</view>
      <custom-card>
        <view class="approval-form">
          <!-- å®¡æ‰¹å†³å®š -->
          <view class="decision-options">
            <view class="option-item {{decision === 'approve' ? 'selected' : ''}}" 
                  data-decision="approve" bind:tap="selectDecision">
              <text class="option-icon">âœ“</text>
              <text class="option-text">æ‰¹å‡†</text>
            </view>
            <view class="option-item {{decision === 'reject' ? 'selected' : ''}}" 
                  data-decision="reject" bind:tap="selectDecision">
              <text class="option-icon">âœ—</text>
              <text class="option-text">æ‹’ç»</text>
            </view>
            <view class="option-item {{decision === 'request_changes' ? 'selected' : ''}}" 
                  data-decision="request_changes" bind:tap="selectDecision">
              <text class="option-icon">!</text>
              <text class="option-text">è¦æ±‚ä¿®æ”¹</text>
            </view>
          </view>

          <!-- å®¡æ‰¹æ„è§ -->
          <view class="comment-section">
            <text class="comment-label">å®¡æ‰¹æ„è§{{decision === 'reject' ? '(å¿…å¡«)' : '(å¯é€‰)'}}:</text>
            <textarea 
              class="comment-input" 
              placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§..."
              value="{{comment}}"
              bind:input="onCommentInput"
              maxlength="200"
            ></textarea>
          </view>

          <!-- æäº¤æŒ‰é’® -->
          <view class="submit-section">
            <custom-button 
              type="primary" 
              text="æäº¤å®¡æ‰¹"
              disabled="{{!decision}}"
              bind:tap="handleApproval"
            ></custom-button>
          </view>
        </view>
      </custom-card>
    </view>
  </view>

  <!-- åˆ·æ–°æŒ‰é’® -->
  <view class="refresh-button" bind:tap="refreshData">
    <text class="refresh-icon">â†»</text>
  </view>
</view>