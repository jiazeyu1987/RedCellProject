<!--å®¶åº­å…³ç³»å›¾è°±ç»„ä»¶æ¨¡æ¿-->
<view class="family-relationship-map {{customClass}}">
  <!-- å·¥å…·æ  -->
  <view class="map-toolbar" wx:if="{{showActions}}">
    <view class="toolbar-left">
      <text class="toolbar-title">å®¶åº­å…³ç³»å›¾è°±</text>
      <text class="member-count">{{nodes.length}}ä½æˆå‘˜</text>
    </view>
    <view class="toolbar-right">
      <button class="tool-btn" bind:tap="resetLayout">
        <text class="tool-icon">âŸ²</text>
        <text class="tool-label">é‡ç½®</text>
      </button>
      <button class="tool-btn" bind:tap="exportMap" wx:if="{{mode === 'edit'}}">
        <text class="tool-icon">ğŸ’¾</text>
        <text class="tool-label">å¯¼å‡º</text>
      </button>
      <button class="tool-btn primary" bind:tap="editMode" wx:if="{{mode === 'view'}}">
        <text class="tool-icon">âœ</text>
        <text class="tool-label">ç¼–è¾‘</text>
      </button>
    </view>
  </view>

  <!-- Canvaså®¹å™¨ -->
  <view class="map-canvas-container">
    <canvas 
      id="{{canvasId}}"
      class="map-canvas"
      type="2d"
      bind:touchstart="onCanvasTouchStart"
      bind:touchmove="onCanvasTouchMove"
      bind:touchend="onCanvasTouchEnd"
      bind:tap="onCanvasTap"
      bind:longpress="onCanvasLongPress"
    ></canvas>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-overlay" wx:if="{{!nodes.length && relationshipData}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨ç”Ÿæˆå…³ç³»å›¾è°±...</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!nodes.length && !relationshipData}}">
      <view class="empty-icon">ğŸ‘¥</view>
      <text class="empty-title">æš‚æ— å®¶åº­å…³ç³»æ•°æ®</text>
      <text class="empty-subtitle">è¯·å…ˆæ·»åŠ å®¶åº­æˆå‘˜ä¿¡æ¯</text>
      <button class="empty-action" bind:tap="addFirstMember" wx:if="{{mode === 'edit'}}">
        æ·»åŠ æˆå‘˜
      </button>
    </view>
  </view>

  <!-- å›¾ä¾‹è¯´æ˜ -->
  <view class="map-legend" wx:if="{{nodes.length > 0}}">
    <view class="legend-title">å›¾ä¾‹è¯´æ˜</view>
    <view class="legend-items">
      <view class="legend-item">
        <view class="legend-icon male"></view>
        <text class="legend-label">ç”·æ€§</text>
      </view>
      <view class="legend-item">
        <view class="legend-icon female"></view>
        <text class="legend-label">å¥³æ€§</text>
      </view>
      <view class="legend-item">
        <view class="legend-line"></view>
        <text class="legend-label">å…³ç³»è¿çº¿</text>
      </view>
      <view class="legend-item">
        <view class="legend-icon selected"></view>
        <text class="legend-label">å½“å‰é€‰ä¸­</text>
      </view>
    </view>
  </view>

  <!-- ç¼©æ”¾æ§åˆ¶ -->
  <view class="zoom-controls" wx:if="{{nodes.length > 0}}">
    <button class="zoom-btn" bind:tap="zoomIn">
      <text class="zoom-icon">+</text>
    </button>
    <view class="zoom-value">{{scalePercentage}}%</view>
    <button class="zoom-btn" bind:tap="zoomOut">
      <text class="zoom-icon">-</text>
    </button>
  </view>

  <!-- èŠ‚ç‚¹ä¿¡æ¯å¡ç‰‡ -->
  <view class="node-info-card {{selectedNode ? 'show' : ''}}" wx:if="{{selectedNode}}">
    <view class="card-header">
      <view class="member-avatar">
        <image wx:if="{{selectedNode.avatar}}" src="{{selectedNode.avatar}}" mode="aspectFill"></image>
        <view wx:else class="avatar-placeholder {{selectedNode.gender}}">
          <text class="avatar-icon">{{selectedNode.gender === 'male' ? 'â™‚' : 'â™€'}}</text>
        </view>
      </view>
      <view class="member-info">
        <text class="member-name">{{selectedNode.name || 'æœªçŸ¥'}}</text>
        <text class="member-details">{{selectedNode.age || '-'}}å² Â· {{selectedNode.relationship || 'æˆå‘˜'}}</text>
        <text class="member-status status-{{selectedNode.healthStatus || 'unknown'}}">
          {{selectedNode.healthStatus === 'healthy' ? 'å¥åº·' : selectedNode.healthStatus === 'chronic' ? 'æ…¢æ€§ç—…' : selectedNode.healthStatus === 'critical' ? 'é«˜å±' : 'æœªçŸ¥'}}
        </text>
      </view>
      <button class="close-btn" bind:tap="closeNodeInfo">Ã—</button>
    </view>
    
    <view class="card-actions" wx:if="{{mode === 'edit'}}">
      <button class="action-btn" bind:tap="editMember" data-member="{{selectedNode}}">
        <text class="action-icon">âœ</text>
        <text class="action-label">ç¼–è¾‘</text>
      </button>
      <button class="action-btn" bind:tap="addRelationship" data-member="{{selectedNode}}">
        <text class="action-icon">ğŸ”—</text>
        <text class="action-label">å»ºç«‹å…³ç³»</text>
      </button>
      <button class="action-btn" bind:tap="viewDetails" data-member="{{selectedNode}}">
        <text class="action-icon">ğŸ‘</text>
        <text class="action-label">è¯¦æƒ…</text>
      </button>
    </view>
  </view>

  <!-- å…³ç³»å»ºç«‹å¼¹çª— -->
  <view class="relationship-modal {{showRelationshipModal ? 'show' : ''}}" wx:if="{{showRelationshipModal}}">
    <view class="modal-overlay" bind:tap="hideRelationshipModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å»ºç«‹å®¶åº­å…³ç³»</text>
        <button class="modal-close" bind:tap="hideRelationshipModal">Ã—</button>
      </view>
      
      <view class="modal-body">
        <view class="relationship-form">
          <view class="form-section">
            <text class="section-label">é€‰æ‹©å…³ç³»å¯¹è±¡</text>
            <scroll-view class="member-list" scroll-y="true">
              <view 
                class="member-item {{targetMemberId === node.id ? 'selected' : ''}}"
                wx:for="{{nodes}}" 
                wx:key="id"
                wx:if="{{item.id !== selectedNode.id}}"
                bind:tap="selectTargetMember"
                data-member-id="{{item.id}}"
              >
                <view class="member-avatar-small">
                  <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill"></image>
                  <view wx:else class="avatar-placeholder-small {{item.gender}}">
                    <text class="avatar-icon-small">{{item.gender === 'male' ? 'â™‚' : 'â™€'}}</text>
                  </view>
                </view>
                <view class="member-info-small">
                  <text class="member-name-small">{{item.name || 'æœªçŸ¥'}}</text>
                  <text class="member-age-small">{{item.age || '-'}}å²</text>
                </view>
              </view>
            </scroll-view>
          </view>
          
          <view class="form-section">
            <text class="section-label">é€‰æ‹©å…³ç³»ç±»å‹</text>
            <view class="relationship-types">
              <button 
                class="relationship-type-btn {{relationshipType === type.value ? 'selected' : ''}}"
                wx:for="{{relationshipTypes}}" 
                wx:key="value"
                bind:tap="selectRelationshipType"
                data-type="{{item.value}}"
              >
                {{item.label}}
              </button>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn cancel" bind:tap="hideRelationshipModal">å–æ¶ˆ</button>
        <button class="modal-btn confirm" bind:tap="confirmRelationship" disabled="{{!targetMemberId || !relationshipType}}">
          ç¡®è®¤å»ºç«‹
        </button>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæç¤º -->
  <view class="operation-tips {{showTips ? 'show' : ''}}" wx:if="{{showTips}}">
    <view class="tip-content">
      <text class="tip-text">{{tipText}}</text>
    </view>
  </view>
</view>